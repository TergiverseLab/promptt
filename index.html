<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRO(m)PP(t)</title>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Cinzel:wght@400;600;900&family=EB+Garamond:ital,wght@0,400;0,500;1,400;1,500&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --white:#ffffff;
  --paper:#f8f5ee;
  --paper-dk:#ece6d8;
  --rule:#b0a48c;
  --ink-lt:#6a6050;
  --ink:#2a2418;
  --black:#0e0c08;
  --deck-w:140px;
  --sidebar-w:300px;
  --bottom-h:340px;
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
body{font-family:"EB Garamond",Georgia,serif;background:var(--paper);color:var(--ink);height:100vh;display:flex;flex-direction:column;overflow:hidden}
#header{background:var(--white);border-bottom:3px double var(--ink);padding:0 24px;display:flex;align-items:center;height:48px;flex-shrink:0;position:relative}
#header-title{font-family:"Cinzel",serif;font-size:11px;color:var(--ink-lt);letter-spacing:1.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#seq{display:none}
/* Corner brand ‚Äî fixed bottom-right */
#corner-brand{position:fixed;bottom:0;right:0;z-index:500;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none;width:260px;padding-bottom:12px}
#corner-logo{height:220px;width:auto;display:block;filter:none;opacity:1}
#corner-taller{font-family:"Cinzel",serif;font-size:11px;letter-spacing:2.5px;color:var(--ink);text-transform:uppercase;text-align:center;font-weight:600}
#main{display:flex;flex:1;min-height:0;overflow:hidden}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{padding:7px 14px;border:2px solid var(--ink);cursor:pointer;font-family:"Cinzel",serif;font-size:10px;font-weight:600;letter-spacing:0.8px;transition:all 0.15s;white-space:nowrap;display:inline-flex;align-items:center;gap:5px}
.btn-dk{background:var(--black);color:var(--white);border-color:var(--black)}.btn-dk:hover{background:var(--ink)}
.btn-lt{background:var(--white);color:var(--black);border-color:var(--ink)}.btn-lt:hover{background:var(--paper)}
.btn-sm{font-size:9px;padding:4px 10px;border-width:1px}

/* ‚îÄ‚îÄ RIVET CORNERS ‚îÄ‚îÄ */
.rv::after{content:"";position:absolute;inset:0;pointer-events:none;z-index:1;
  background:radial-gradient(circle 4px at 10px 10px,var(--ink) 50%,transparent 51%),
  radial-gradient(circle 4px at calc(100% - 10px) 10px,var(--ink) 50%,transparent 51%),
  radial-gradient(circle 4px at 10px calc(100% - 10px),var(--ink) 50%,transparent 51%),
  radial-gradient(circle 4px at calc(100% - 10px) calc(100% - 10px),var(--ink) 50%,transparent 51%)}
.rv-lt::after{content:"";position:absolute;inset:0;pointer-events:none;z-index:1;
  background:radial-gradient(circle 4px at 10px 10px,var(--rule) 50%,transparent 51%),
  radial-gradient(circle 4px at calc(100% - 10px) 10px,var(--rule) 50%,transparent 51%),
  radial-gradient(circle 4px at 10px calc(100% - 10px),var(--rule) 50%,transparent 51%),
  radial-gradient(circle 4px at calc(100% - 10px) calc(100% - 10px),var(--rule) 50%,transparent 51%)}

/* ‚îÄ‚îÄ DECK PANEL ‚îÄ‚îÄ */
#deck-panel{width:var(--deck-w);background:var(--white);border-right:3px double var(--ink);display:flex;flex-direction:column;align-items:center;padding:16px 8px 10px;gap:10px;flex-shrink:0;position:relative;overflow:hidden}
#deck-panel h3{font-family:"Cinzel",serif;font-size:10px;color:var(--ink-lt);text-transform:uppercase;letter-spacing:2.5px;z-index:2}
#deck-stack{position:relative;width:86px;height:120px;cursor:grab;user-select:none;z-index:2;flex-shrink:0}
#deck-stack:active{cursor:grabbing}
.dshadow{position:absolute;width:82px;height:116px;background:var(--paper-dk);border:1px solid var(--rule)}
.dshadow:nth-child(1){top:4px;left:4px}.dshadow:nth-child(2){top:2px;left:2px}
#deck-top{position:absolute;top:0;left:0;width:82px;height:116px;background:var(--paper);border:2px solid var(--ink);display:flex;align-items:center;justify-content:center;transition:transform 0.15s,box-shadow 0.15s;overflow:hidden;z-index:3}
#deck-top::before{content:"";position:absolute;inset:5px;border:1px solid var(--rule);pointer-events:none}
#deck-top:hover{transform:translateY(-5px) rotate(-1.5deg);box-shadow:5px 8px 0 var(--ink)}
#deck-top img{width:64px;opacity:0.65;filter:grayscale(1)}
@keyframes shuffleA{0%{transform:none}20%{transform:translateX(-14px) rotate(-7deg)}40%{transform:translateX(16px) rotate(5deg)}60%{transform:translateX(-9px) rotate(-3deg)}80%{transform:translateX(7px) rotate(2deg)}100%{transform:none}}
#deck-stack.shuffling #deck-top{animation:shuffleA 0.55s ease-in-out}
#deck-stack.shuffling .dshadow:nth-child(1){animation:shuffleA 0.55s ease-in-out 0.06s}
#deck-stack.shuffling .dshadow:nth-child(2){animation:shuffleA 0.55s ease-in-out 0.12s}
#deck-count{font-family:"Cinzel",serif;font-size:30px;font-weight:900;color:var(--black);line-height:1;z-index:2}
#deck-lbl{font-family:"Cinzel",serif;font-size:9px;color:var(--rule);letter-spacing:2px;margin-top:-5px;z-index:2}
#deck-panel .btn{width:112px;justify-content:center;z-index:2;font-size:9px;padding:6px 0}

/* ‚îÄ‚îÄ CENTER ‚îÄ‚îÄ */
#center{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

/* ‚îÄ‚îÄ TABLE (upper half) ‚îÄ‚îÄ */
#table{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--paper);border-bottom:3px double var(--ink);position:relative;min-height:0}
.t-orn{position:absolute;font-size:18px;color:var(--rule);pointer-events:none;z-index:1;line-height:1;opacity:0.5}
#to-tl{top:40px;left:10px}#to-tr{top:40px;right:10px}#to-bl{bottom:8px;left:10px}#to-br{bottom:8px;right:10px}

/* Table tabs */
#ttabs{display:flex;flex-shrink:0;background:var(--white);border-bottom:3px double var(--ink);z-index:2;position:relative}
.ttab{padding:11px 22px;font-family:"Cinzel",serif;font-size:11px;font-weight:600;color:var(--rule);cursor:pointer;border-bottom:3px solid transparent;letter-spacing:1.2px;transition:all 0.15s;border-right:1px solid var(--rule)}
.ttab.active{color:var(--black);border-bottom-color:var(--black);background:var(--paper)}
.ttab:hover:not(.active){color:var(--ink)}

/* ‚îÄ‚îÄ KEY: panels are display:none by default, flex when active ‚îÄ‚îÄ */
.tpanel{display:none;flex:1;overflow:hidden;min-height:0}
.tpanel.active{display:flex;flex-direction:column}

/* Card panel */
#panel-card{align-items:center;justify-content:center;background:var(--paper)}
#table-hint{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;pointer-events:none;transition:opacity 0.3s}
#table-hint img{width:70px;opacity:0.06;filter:grayscale(1)}
#table-hint p{font-family:"Cinzel",serif;font-size:11px;color:var(--rule);letter-spacing:2px;text-align:center;line-height:2.2}
#table-hint.hidden{opacity:0}
#card-preview{display:flex;flex-direction:column;align-items:center;gap:12px;opacity:0;transition:opacity 0.3s;pointer-events:none;position:relative;z-index:2}
#card-preview.visible{opacity:1;pointer-events:all}
#card-frame{background:var(--white);border:3px solid var(--black);box-shadow:8px 8px 0 var(--ink);position:relative;padding:8px}
#card-frame::before{content:"";position:absolute;inset:4px;border:1px solid var(--rule);pointer-events:none;z-index:1}
#card-frame::after{content:"";position:absolute;inset:0;pointer-events:none;z-index:2;
  background:radial-gradient(circle 5px at 12px 12px,var(--ink) 50%,transparent 51%),radial-gradient(circle 5px at calc(100% - 12px) 12px,var(--ink) 50%,transparent 51%),radial-gradient(circle 5px at 12px calc(100% - 12px),var(--ink) 50%,transparent 51%),radial-gradient(circle 5px at calc(100% - 12px) calc(100% - 12px),var(--ink) 50%,transparent 51%)}
#card-preview-img{width:220px;display:block;cursor:pointer;position:relative;z-index:0;transition:filter 0.2s}
#card-preview-img:hover{filter:brightness(1.04)}
#card-preview-title{font-family:"UnifrakturMaguntia",serif;font-size:28px;color:var(--black);letter-spacing:1px}
#ver-nav{display:none;align-items:center;gap:12px}
#ver-lbl{font-family:"Cinzel",serif;font-size:11px;color:var(--ink-lt);letter-spacing:1px}

/* Spread panel ‚Äî scrollable inner content */
#panel-spread{background:var(--paper)}
#spread-toolbar{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:2px solid var(--ink);background:var(--white);flex-shrink:0;flex-wrap:wrap}
#spread-toolbar-lbl{font-family:"Cinzel",serif;font-size:9px;color:var(--ink-lt);letter-spacing:2px;flex-shrink:0}
#spread-sort-btns{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.ssb{font-family:"Cinzel",serif;font-size:9px;padding:4px 10px;border:1px solid var(--ink);background:var(--paper);color:var(--ink-lt);cursor:pointer;letter-spacing:0.5px;display:inline-flex;align-items:center;gap:5px;transition:all 0.15s}
.ssb:hover{background:var(--paper-dk);color:var(--ink)}
.ssb.active{background:var(--black);color:var(--white);border-color:var(--black)}
.ssb.active .sdot{border-color:var(--white)}
.sdot{width:8px;height:8px;border-radius:50%;border:1.5px solid var(--ink-lt);flex-shrink:0;display:inline-block}
.sdot-g{background:#555}.sdot-o{background:#888}.sdot-b{background:#333}
#spread-scroll{flex:1;overflow-y:auto;padding:16px;min-height:0}
#spread-scroll::-webkit-scrollbar{width:4px}
#spread-scroll::-webkit-scrollbar-thumb{background:var(--ink)}
#spread-grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.spread-section{width:100%;margin-bottom:12px}
.spread-section-title{font-family:"Cinzel",serif;font-size:9px;color:var(--ink-lt);letter-spacing:2px;text-transform:uppercase;padding:4px 0 6px;border-bottom:1px solid var(--rule);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.spread-cards-row{display:flex;flex-wrap:wrap;gap:8px}
.spread-card{width:80px;height:116px;border:2px solid var(--ink);cursor:pointer;overflow:hidden;position:relative;transition:transform 0.15s,box-shadow 0.15s;flex-shrink:0;background:var(--white);box-shadow:3px 3px 0 var(--ink)}
.spread-card:hover{transform:translateY(-4px);box-shadow:5px 7px 0 var(--ink)}
.spread-card.in-tl{opacity:0.35}
.spread-card img{width:100%;height:100%;object-fit:cover;display:block}
.spread-card-name{position:absolute;bottom:0;left:0;right:0;background:rgba(14,12,8,0.88);color:var(--white);font-family:"Cinzel",serif;font-size:6.5px;letter-spacing:0.5px;padding:3px 4px;text-align:center}

/* Story panel ‚Äî scrollable */
#panel-story{background:var(--paper)}
#story-source-bar{display:flex;gap:0;border-bottom:2px solid var(--ink);flex-shrink:0;margin-bottom:12px}
.story-src-btn{flex:1;padding:8px 12px;font-family:"Cinzel",serif;font-size:10px;font-weight:600;letter-spacing:1px;cursor:pointer;border:none;border-right:1px solid var(--ink);background:var(--paper-dk);color:var(--rule);transition:all 0.15s}
.story-src-btn:last-child{border-right:none}
.story-src-btn.active{background:var(--black);color:var(--white)}
.story-src-btn:hover:not(.active){background:var(--paper);color:var(--ink)}
#story-scroll{flex:1;overflow-y:auto;padding:22px 32px 24px}
#story-scroll::-webkit-scrollbar{width:4px}
#story-scroll::-webkit-scrollbar-thumb{background:var(--ink)}
#story-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--ink)}
#story-funcs{font-family:"Cinzel",serif;font-size:9px;color:var(--ink-lt);letter-spacing:0.8px;flex:1;line-height:1.8}
#story-badge{font-family:"Cinzel",serif;font-size:9px;padding:4px 12px;border:2px solid var(--ink);color:var(--black);letter-spacing:1px;flex-shrink:0}
#story-body{max-width:640px;margin:0 auto}
.story-para{margin-bottom:20px;padding-left:16px;position:relative}
.story-para::before{content:"";position:absolute;left:0;top:2px;bottom:2px;width:2px;background:repeating-linear-gradient(180deg,var(--ink) 0,var(--ink) 4px,transparent 4px,transparent 8px)}
.story-func-tag{font-family:"Cinzel",serif;font-size:8px;color:var(--ink-lt);letter-spacing:2.5px;text-transform:uppercase;margin-bottom:3px}
.story-para-text{font-family:"EB Garamond",Georgia,serif;font-size:16px;line-height:1.9;color:var(--black)}
.story-para:first-child .story-para-text::first-letter{font-family:"UnifrakturMaguntia",serif;font-size:3.5em;float:left;line-height:0.78;margin-right:6px;margin-top:6px;color:var(--black)}
#story-placeholder{font-family:"EB Garamond",serif;font-size:15px;font-style:italic;color:var(--rule);text-align:center;padding:36px 0}
@keyframes inkP{0%,100%{opacity:0.4}50%{opacity:1}}
#story-generating{font-family:"EB Garamond",serif;font-size:15px;font-style:italic;color:var(--ink);text-align:center;padding:36px 0;display:none;animation:inkP 1.6s ease infinite}
#story-moralia{margin-top:24px;padding:16px 20px;border:2px solid var(--ink);background:var(--paper-dk);display:none;position:relative}
#story-moralia::before{content:"‚ú¶";position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--paper);padding:0 10px;font-size:14px;color:var(--ink)}
#moralia-lbl{font-family:"Cinzel",serif;font-size:9px;color:var(--ink-lt);letter-spacing:2.5px;margin-bottom:6px}
#moralia-text{font-family:"EB Garamond",serif;font-style:italic;font-size:15px;color:var(--black);line-height:1.65}

/* ‚îÄ‚îÄ BOTTOM SECTION ‚îÄ‚îÄ */
#bottom{flex-shrink:0;display:flex;flex-direction:column;border-top:3px double var(--ink);background:var(--white)}
#tl-wrap{background:var(--paper-dk);border-bottom:2px solid var(--ink);display:flex;flex-direction:column;padding:4px 12px 8px;position:relative;min-height:0;flex-shrink:0}
#tl-label{font-family:"Cinzel",serif;font-size:9px;color:var(--ink-lt);letter-spacing:2.5px;z-index:2;padding:4px 0 2px}
#tl-wrap::after{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle 4px at 10px 10px,var(--ink) 50%,transparent 51%),radial-gradient(circle 4px at calc(100% - 10px) 10px,var(--ink) 50%,transparent 51%),radial-gradient(circle 4px at 10px calc(100% - 10px),var(--ink) 50%,transparent 51%),radial-gradient(circle 4px at calc(100% - 10px) calc(100% - 10px),var(--ink) 50%,transparent 51%)}
#tl{display:flex;align-items:center;gap:7px;overflow-x:auto;padding:0 4px 4px;flex:1;scrollbar-width:thin;scrollbar-color:var(--ink-lt) transparent;position:relative;z-index:2}
#tl::-webkit-scrollbar{height:4px}
#tl::-webkit-scrollbar-thumb{background:var(--ink-lt)}
/* Monomito timeline ‚Äî two balanced rows */
#tl-mm{display:none;flex-direction:column;gap:3px;overflow-x:auto;padding:4px 4px 6px;flex:1;scrollbar-width:thin;scrollbar-color:var(--ink-lt) transparent;z-index:2}
#tl-mm::-webkit-scrollbar{height:4px}
#tl-mm::-webkit-scrollbar-thumb{background:var(--ink-lt)}
.tl-mm-row{display:flex;align-items:center;gap:0;flex-wrap:nowrap;flex-shrink:0}
.tl-mm-item{font-family:"Cinzel",serif;font-size:9px;letter-spacing:0.3px;cursor:grab;white-space:nowrap;padding:3px 6px;border:1px solid transparent;transition:all 0.15s;flex-shrink:0;user-select:none;background:var(--paper)}
.tl-mm-item:hover{border-color:var(--rule)}
.tl-mm-item.active{color:var(--black);font-weight:700;border-color:var(--ink);background:var(--paper-dk)}
.tl-mm-item.done{color:var(--ink)}
.tl-mm-item:not(.done):not(.active){color:var(--ink-lt)}
.tl-mm-arrow{font-family:"Cinzel",serif;font-size:11px;color:var(--rule);flex-shrink:0;user-select:none;padding:0 1px}
.tl-slot{flex-shrink:0;width:80px;height:120px;border:1px dashed var(--rule);display:flex;align-items:center;justify-content:center}
.tl-slot.occupied{border:none}
.tl-card{width:78px;height:118px;background:var(--white);border:2px solid var(--ink);cursor:pointer;transition:transform 0.15s,box-shadow 0.15s,border-color 0.15s;position:relative;user-select:none;overflow:hidden}
.tl-card:hover{transform:translateY(-7px) rotate(-0.5deg);box-shadow:4px 8px 0 var(--ink);border-color:var(--black);z-index:10}
.tl-card.selected{border:3px solid var(--black);box-shadow:0 0 0 2px var(--rule),4px 8px 0 rgba(0,0,0,0.5)}
.tl-card.dragging{opacity:0.18;transform:scale(0.9)}
.tl-card img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
.card-num{position:absolute;bottom:2px;left:2px;font-family:"Cinzel",serif;font-size:9px;font-weight:700;color:var(--black);background:rgba(248,245,238,0.94);padding:0 4px;line-height:1.5}
.card-del{position:absolute;top:2px;right:2px;background:rgba(14,12,8,0.9);color:var(--white);border:none;width:18px;height:18px;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center}
.tl-card:hover .card-del{display:flex}
.drop-ind{flex-shrink:0;width:4px;height:110px;background:transparent;transition:background 0.15s}
.drop-ind.active{background:linear-gradient(180deg,transparent,var(--ink),transparent)}

/* ‚îÄ‚îÄ SCRIPTORIUM ‚îÄ‚îÄ */
#scriptorium{background:var(--white);border-top:2px solid var(--ink);flex-shrink:0;padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:10px;position:relative}
#scriptorium::after{content:"";position:absolute;inset:0;pointer-events:none;z-index:0;background:radial-gradient(circle 4px at 10px 10px,var(--ink) 50%,transparent 51%),radial-gradient(circle 4px at calc(100% - 10px) 10px,var(--ink) 50%,transparent 51%),radial-gradient(circle 4px at 10px calc(100% - 10px),var(--ink) 50%,transparent 51%),radial-gradient(circle 4px at calc(100% - 10px) calc(100% - 10px),var(--ink) 50%,transparent 51%)}
#scr-label{font-family:"UnifrakturMaguntia",serif;font-size:22px;color:var(--black);flex-shrink:0;z-index:1;white-space:nowrap}
.scr-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex:1;z-index:1;min-width:0}
#api-key{flex:1;min-width:140px;background:var(--paper);border:2px solid var(--ink);color:var(--black);font-family:"EB Garamond",serif;font-size:14px;padding:6px 10px;height:38px}
#api-key:focus{outline:2px solid var(--black);border-color:var(--black)}
#model-sel,#mode-sel{background:var(--paper);border:2px solid var(--ink);color:var(--black);font-family:"Cinzel",serif;font-size:10px;padding:5px 8px;height:38px;letter-spacing:0.5px;flex-shrink:0}
.scr-btn{height:38px;font-size:10px;padding:0 16px;z-index:1;flex-shrink:0}
.rt-box{display:flex;align-items:center;gap:8px;flex-shrink:0;border:2px solid var(--ink);padding:6px 14px;background:var(--paper);z-index:1;height:38px}
.rt-box label.rt-lbl{font-family:"Cinzel",serif;font-size:10px;color:var(--black);letter-spacing:1px;white-space:nowrap;cursor:pointer;user-select:none}
.tog{position:relative;width:40px;height:20px;flex-shrink:0}
.tog input{opacity:0;width:0;height:0;position:absolute}
.tog-sl{position:absolute;cursor:pointer;inset:0;background:var(--paper-dk);border:2px solid var(--ink);transition:0.2s}
.tog-sl::before{content:"";position:absolute;height:12px;width:12px;left:2px;bottom:2px;background:var(--ink);transition:0.2s}
.tog input:checked+.tog-sl{background:var(--ink)}
.tog input:checked+.tog-sl::before{transform:translateX(20px);background:var(--white)}
#rt-status{font-family:"Cinzel",serif;font-size:9px;color:var(--rule);letter-spacing:1px;display:none;z-index:1;flex-shrink:0}
#rt-status.on{display:block;color:var(--black);font-weight:700}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar,#sb-monomito{width:var(--sidebar-w);background:var(--white);border-left:3px double var(--ink);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#sb-monomito{display:none}
#sb-head{padding:14px 16px 12px;border-bottom:2px solid var(--ink);flex-shrink:0;position:relative}
#sb-head::after{content:"‚îÄ‚îÄ‚îÄ ‚ú¶ ‚îÄ‚îÄ‚îÄ";position:absolute;bottom:-9px;left:0;right:0;text-align:center;font-size:10px;color:var(--rule);letter-spacing:3px;font-family:"Cinzel",serif;background:var(--white);width:fit-content;margin:0 auto;padding:0 8px}
#sb-title{font-family:"UnifrakturMaguntia",serif;font-size:24px;color:var(--black);letter-spacing:0.5px}
#sb-sub{font-family:"Cinzel",serif;font-size:9px;color:var(--rule);letter-spacing:2px;margin-top:4px}
.stab-bar{display:flex;border-bottom:2px solid var(--ink);flex-shrink:0;margin-top:10px;background:var(--paper-dk)}
.stab{flex:1;padding:10px 3px;font-family:"Cinzel",serif;font-size:10px;font-weight:600;text-align:center;cursor:pointer;color:var(--rule);border-bottom:2px solid transparent;letter-spacing:0.8px;transition:all 0.15s;border-right:1px solid var(--rule)}
.stab.active{color:var(--black);border-bottom-color:var(--black);background:var(--white)}
.stab:hover:not(.active){color:var(--ink)}
.stab-panel{display:none;flex:1;overflow-y:auto;padding:14px 16px}
.stab-panel.active{display:block}
.stab-panel::-webkit-scrollbar{width:4px}
.stab-panel::-webkit-scrollbar-thumb{background:var(--ink)}
.sec-lbl{font-family:"Cinzel",serif;font-size:10px;color:var(--ink-lt);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--rule);display:flex;justify-content:space-between;align-items:center}
.edit-btn{font-size:10px;cursor:pointer;color:var(--rule);font-family:"Cinzel",serif;letter-spacing:0.5px}
.edit-btn:hover{color:var(--black)}
.sb-text{font-family:"EB Garamond",Georgia,serif;font-size:15px;line-height:1.7;color:var(--ink)}
.sb-italic{font-style:italic;color:var(--ink-lt)}
.sb-example{margin-top:10px;padding:8px 12px;border-left:3px solid var(--ink);background:var(--paper)}
.sb-ex-lbl{font-family:"Cinzel",serif;font-size:9px;color:var(--ink-lt);letter-spacing:1.5px;margin-bottom:4px}
.edit-area{display:none;width:100%;background:var(--paper);border:1px solid var(--ink);color:var(--black);font-family:"EB Garamond",serif;font-size:13px;padding:6px 8px;resize:vertical;min-height:60px;margin-top:4px}
.edit-area:focus{outline:1px solid var(--rule)}
.ver-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.ver-thumb{position:relative;width:56px;height:80px;border:2px solid var(--ink);overflow:hidden;cursor:pointer}
.ver-thumb img{width:100%;height:100%;object-fit:cover}
.ver-thumb.cur{border:3px solid var(--black);box-shadow:2px 2px 0 var(--ink)}
.ver-num{position:absolute;bottom:1px;left:2px;font-family:"Cinzel",serif;font-size:8px;color:var(--white);background:rgba(14,12,8,0.85);padding:0 3px}
.ver-del{position:absolute;top:1px;right:1px;background:rgba(14,12,8,0.9);color:var(--white);border:none;width:15px;height:15px;font-size:8px;cursor:pointer;display:none;align-items:center;justify-content:center}
.ver-thumb:hover .ver-del{display:flex}
.cfg-section{border:2px solid var(--ink);margin-bottom:10px;overflow:hidden}
.cfg-head{font-family:"Cinzel",serif;font-size:10px;color:var(--ink-lt);letter-spacing:1.5px;padding:7px 10px;background:var(--paper-dk);border-bottom:1px solid var(--ink)}
.cfg-body{padding:8px 10px}
.cfg-body p{font-family:"EB Garamond",serif;font-size:13px;color:var(--ink-lt);margin-bottom:6px;line-height:1.5}
.file-lbl{display:inline-block;padding:5px 12px;font-family:"Cinzel",serif;font-size:9px;border:2px solid var(--ink);color:var(--black);cursor:pointer;letter-spacing:1px;background:var(--paper)}
.file-lbl:hover{background:var(--paper-dk)}
.file-input{display:none}
#sb-empty{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;padding:20px}
#sb-empty img{width:56px;opacity:0.1;filter:grayscale(1)}
#sb-empty p{font-family:"Cinzel",serif;font-size:10px;color:var(--rule);letter-spacing:1.5px;text-align:center;line-height:2.4}

/* ‚îÄ‚îÄ MONOMITO ‚îÄ‚îÄ */
#panel-monomito{background:var(--paper);align-items:center;justify-content:center;flex-direction:column}
#monomito-wheel-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:6px;width:100%;min-height:0;overflow:hidden}
#monomito-svg{width:min(680px,calc(100vh - 200px));height:min(680px,calc(100vh - 200px));overflow:visible;display:block;transition:transform 0.2s;transform-origin:center center}
#monomito-actions{flex-shrink:0;padding:10px 16px;border-top:2px solid var(--ink);background:var(--white);display:flex;gap:8px;flex-wrap:wrap;width:100%;box-sizing:border-box}
#sb-mm-body::-webkit-scrollbar{width:4px}
#sb-mm-body::-webkit-scrollbar-thumb{background:var(--ink)}
#sb-mm-head{padding:14px 16px 12px;border-bottom:2px solid var(--ink);flex-shrink:0;background:var(--white)}
#sb-mm-body{flex:1;overflow-y:auto;padding:14px 16px;background:var(--white)}
#monomito-empty{display:flex;align-items:center;justify-content:center;flex-direction:column;padding:40px 20px;font-family:"Cinzel",serif;font-size:11px;color:var(--ink-lt);letter-spacing:1.5px;text-align:center;line-height:2.4;border:1px dashed var(--rule);margin:16px}
#monomito-detail{display:none}
#mm-stage-num-label{font-family:"Cinzel",serif;font-size:9px;color:var(--rule);letter-spacing:3px;margin-bottom:4px}
#mm-stage-name-label{font-family:"UnifrakturMaguntia",serif;font-size:22px;color:var(--black)}
.mm-segment{cursor:grab;transition:transform 0.18s cubic-bezier(.34,1.56,.64,1)}
.mm-segment:active{cursor:grabbing}
.mm-seg-path{fill:var(--paper);stroke:var(--ink);stroke-width:1.3;transition:fill 0.12s}
.mm-segment:hover:not(.active):not(.mm-dragging) .mm-seg-path{fill:var(--paper-dk)}
.mm-segment.active .mm-seg-path{fill:var(--ink) !important}
.mm-segment.done:not(.active) .mm-seg-path{fill:#d8d4cc}
.mm-segment.mm-dragging .mm-seg-path{fill:var(--paper-dk) !important;stroke-width:2.5}
.mm-segment{cursor:grab;transition:transform 0.12s}
.mm-done-dot{fill:var(--ink);pointer-events:none}
.mm-segment.active .mm-done-dot{fill:var(--white) !important}
.mm-seg-label{font-family:"Cinzel",serif;font-size:8px;fill:var(--ink);pointer-events:none}
.mm-seg-num{font-family:"Cinzel",serif;font-size:11px;font-weight:700;fill:var(--rule);pointer-events:none}
.mm-segment.active .mm-seg-label{fill:var(--white) !important}
.mm-segment.active .mm-seg-num{fill:var(--white) !important}
.mm-segment:active{cursor:grabbing}
#mm-propp-cards .spread-card{width:52px;height:74px;cursor:pointer}
#mm-propp-cards .spread-card img{width:100%;height:52px;object-fit:cover}
#mm-propp-cards .spread-card-name{font-size:5px;padding:2px 3px;text-align:center}

#floater{position:fixed;pointer-events:none;z-index:1000;display:none;border:2px solid var(--black);overflow:hidden;transform:rotate(2.5deg);box-shadow:5px 5px 0 rgba(0,0,0,0.4)}
#floater img{width:80px;height:116px;display:block}

/* ‚îÄ‚îÄ ADD CARD MODAL ‚îÄ‚îÄ */
#add-modal{position:fixed;inset:0;background:rgba(14,12,8,0.7);z-index:2000;display:none;align-items:center;justify-content:center}
#add-modal.open{display:flex}
#add-modal-box{background:var(--white);border:3px solid var(--black);box-shadow:10px 10px 0 var(--ink);padding:28px 32px;max-width:480px;width:90%;position:relative}
#add-modal-box::before{content:"";position:absolute;inset:6px;border:1px solid var(--rule);pointer-events:none}
#add-modal-box h2{font-family:"UnifrakturMaguntia",serif;font-size:26px;color:var(--black);margin-bottom:16px}
.modal-field{margin-bottom:14px}
.modal-field label{font-family:"Cinzel",serif;font-size:10px;color:var(--ink-lt);letter-spacing:1.5px;display:block;margin-bottom:5px}
.modal-field input,.modal-field textarea{width:100%;background:var(--paper);border:2px solid var(--ink);color:var(--black);font-family:"EB Garamond",serif;font-size:14px;padding:8px 10px}
.modal-field textarea{min-height:60px;resize:vertical}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
</style>
</head>
<body>

<div id="header">
  <div id="header-title">Bienvenido a Pro(m)pp(t) Generator &nbsp;¬∑&nbsp; Arrastra cartas a la l√≠nea narrativa</div>
</div>

<div id="corner-brand">
  <img id="corner-logo" src="logo_promppt.png" alt="PRO(m)PP(t)">
  <div id="corner-taller">Taller audiovisual BAU</div>
</div>

<div id="main">
  <div id="deck-panel">
    <h3>Mazo</h3>
    <div id="deck-stack">
      <div class="dshadow"></div><div class="dshadow"></div>
      <div id="deck-top"><img id="deck-logo" src="" alt=""></div>
    </div>
    <div id="deck-count">31</div>
    <div id="deck-lbl">CARTAS</div>
    <button class="btn btn-dk" id="btn-shuffle" style="margin-top:4px">‚áå Barajar</button>
    <button class="btn btn-dk" id="btn-spread">‚äû Baraja</button>
    <button class="btn btn-dk" id="btn-reset">‚Ü∫ Reiniciar</button>
  </div>

  <div id="center">
    <div id="table">
      <span class="t-orn" id="to-tl">‚ùß</span><span class="t-orn" id="to-tr">‚òô</span>
      <span class="t-orn" id="to-bl">‚ú¶</span><span class="t-orn" id="to-br">‚ú¶</span>
      <div id="ttabs">
        <div class="ttab active" data-panel="card">‚ú¶ CARTA</div>
        <div class="ttab" data-panel="spread">‚äû BARAJA</div>
        <div class="ttab" data-panel="monomito">‚òØ MONOMITO</div>
        <div class="ttab" data-panel="story">üìú RELATO</div>
      </div>

      <!-- CARTA panel -->
      <div class="tpanel active" id="panel-card">
        <div id="table-hint">
          <img id="hint-logo" src="" alt="">
          <p>ARRASTRA CARTAS DESDE EL MAZO<br>O DESPLIEGA LA BARAJA</p>
        </div>
        <div id="card-preview">
          <div id="card-frame">
            <img id="card-preview-img" src="" alt="" title="Clic ‚Üí siguiente versi√≥n">
          </div>
          <div id="card-preview-title"></div>
          <div id="ver-nav">
            <button class="btn btn-lt btn-sm" onclick="cycleVer(-1)">&#8249;</button>
            <span id="ver-lbl">1/1</span>
            <button class="btn btn-lt btn-sm" onclick="cycleVer(1)">&#8250;</button>
          </div>
        </div>
      </div>

      <!-- BARAJA panel -->
      <div class="tpanel" id="panel-spread">
        <div id="spread-toolbar">
          <span id="spread-toolbar-lbl">VER</span>
          <div id="spread-sort-btns">
            <button class="ssb active" data-phase="all" onclick="setSpreadView('all')">Todas</button>
            <button class="ssb" data-phase="inicio" onclick="setSpreadView('inicio')"><span class="sdot sdot-g"></span>Principio</button>
            <button class="ssb" data-phase="nudo" onclick="setSpreadView('nudo')"><span class="sdot sdot-o"></span>Nudo</button>
            <button class="ssb" data-phase="desenlace" onclick="setSpreadView('desenlace')"><span class="sdot sdot-b"></span>Desenlace</button>
            <button class="ssb" data-phase="order" onclick="setSpreadView('order')">‚ú¶ En orden narrativo</button>
          </div>
          <button class="btn btn-dk btn-sm" id="add-card-btn">+ Nueva carta</button>
        </div>
        <div id="spread-scroll">
          <div id="spread-grid"></div>
        </div>
      </div>

      <!-- MONOMITO panel ‚Äî solo la rueda -->
      <div class="tpanel" id="panel-monomito">
        <div id="monomito-wheel-wrap">
          <svg id="monomito-svg" viewBox="-250 -250 500 500" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
        <div id="monomito-actions">
          <button class="btn btn-lt btn-sm" onclick="mmZoom(0.15)" title="Acercar">Ôºã</button>
          <button class="btn btn-lt btn-sm" onclick="mmZoom(-0.15)" title="Alejar">Ôºç</button>
          <button class="btn btn-lt btn-sm" onclick="mmZoomReset()" title="Restablecer zoom">‚äô</button>
          <button class="btn btn-lt btn-sm" onclick="downloadMMFragments()">‚éò Exportar fragmentos</button>
          <button class="btn btn-lt btn-sm" onclick="clearMonomito()">‚úï Limpiar rueda</button>
        </div>
      </div>

      <!-- RELATO panel -->
      <div class="tpanel" id="panel-story">
        <div id="story-scroll">
          <div id="story-header">
            <div id="story-source-bar">
              <button class="story-src-btn active" id="src-propp-btn" onclick="setStorySrc('propp')">‚äû Funciones Propp</button>
              <button class="story-src-btn" id="src-mm-btn" onclick="setStorySrc('monomito')">‚òØ Monomito Campbell</button>
            </div>
            <div id="story-funcs">‚Äî</div>
            <div id="story-badge">‚Äî</div>
          </div>
          <div id="story-body">
            <div id="story-placeholder" data-propp="Coloca funciones en la secuencia narrativa y pulsa &lt;em&gt;Componer&lt;/em&gt;.<br><small style='font-size:12px;opacity:0.5;display:block;margin-top:10px'>Gram√°tica creativa seg√∫n Rodari sobre Propp.</small>" data-monomito="Selecciona segmentos en la rueda del Monomito y pulsa &lt;em&gt;Componer&lt;/em&gt;.<br><small style='font-size:12px;opacity:0.5;display:block;margin-top:10px'>El Viaje del H√©roe seg√∫n Campbell.</small>">Coloca funciones en la secuencia narrativa y pulsa <em>Componer</em>.<br><small style="font-size:12px;opacity:0.5;display:block;margin-top:10px">Gram√°tica creativa seg√∫n Rodari sobre Propp.</small></div>
            <div id="story-generating">‚ú¶ Componiendo el relato‚Ä¶</div>
          </div>
          <div id="story-moralia">
            <div id="moralia-lbl">MORALEJA</div>
            <div id="moralia-text"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="bottom">
      <div id="tl-wrap">
        <span id="tl-label">L√çNEA NARRATIVA</span>
        <div id="tl"></div>
        <div id="tl-mm" style="display:none"></div>
      </div>
      <div id="scriptorium">
        <span id="scr-label">Scriptorium</span>
        <div class="scr-row">
          <input type="text" id="api-key" placeholder="API key Groq‚Ä¶" autocomplete="off" spellcheck="false">
          <button id="btn-save-key" class="btn btn-lt btn-sm" title="Guardar API key en este navegador" style="height:38px;flex-shrink:0">üíæ</button>
          <a id="api-link" href="https://console.groq.com/keys" target="_blank" class="btn btn-lt btn-sm" title="Obtener API key" style="height:38px;display:inline-flex;align-items:center;text-decoration:none;flex-shrink:0">üîë</a>
          <select id="model-sel"><option value="groq">Llama 3.3 ¬∑ Groq (gratis)</option><option value="mistral">Mistral Large ¬∑ Mistral (gratis)</option><option value="gemini">Gemini 2.5 Flash ¬∑ Google</option><option value="claude">Claude Sonnet 4.6 ¬∑ Anthropic</option></select>
          <select id="mode-sel"><option value="folklore">Folklore ¬∑ Cuento</option><option value="contemporary">Contempor√°neo</option></select>
          <button class="btn btn-dk scr-btn" id="btn-compose">‚öú Componer</button>
          <button class="btn btn-lt scr-btn" id="btn-clear">‚úï Limpiar</button>
          <div class="rt-box">
            <label class="tog" for="rt-sw"><input type="checkbox" id="rt-sw"><span class="tog-sl"></span></label>
            <label class="rt-lbl" for="rt-sw">Tiempo real</label>
          </div>
          <span id="rt-status">‚óè ACTIVO</span>
        </div>
      </div>
    </div>
  </div>

  <div id="sidebar">
    <div id="sb-head">
      <div id="sb-title">PRO(m)PP(t)</div>
      <div id="sb-sub">SELECCIONA UNA CARTA</div>
    </div>
    <div id="sb-content" style="display:none;flex:1;flex-direction:column;overflow:hidden">
      <div class="stab-bar">
        <div class="stab active" data-stab="propp">PROPP</div>
        <div class="stab" data-stab="rodari">RODARI</div>
        <div class="stab" data-stab="campbell">CAMPBELL</div>
        <div class="stab" data-stab="config">&#9881;</div>
      </div>
      <div class="stab-panel active" id="stab-propp">
        <div class="sec-lbl">FUNCI√ìN SEG√öN PROPP<span class="edit-btn" onclick="toggleEdit('propp')">‚úé editar</span></div>
        <p class="sb-text" id="txt-propp"></p>
        <textarea class="edit-area" id="ea-propp" rows="3"></textarea>
        <button class="btn btn-dk btn-sm" id="sv-propp" style="display:none;margin-top:5px" onclick="saveEdit('propp')">Guardar</button>
        <div class="sb-example"><div class="sb-ex-lbl">EJEMPLO</div><p class="sb-text sb-italic" id="ex-propp"></p></div>
      </div>
      <div class="stab-panel" id="stab-rodari">
        <div class="sec-lbl">INTERPRETACI√ìN RODARI<span class="edit-btn" onclick="toggleEdit('rodari')">‚úé editar</span></div>
        <p class="sb-text" id="txt-rodari"></p>
        <textarea class="edit-area" id="ea-rodari" rows="3"></textarea>
        <button class="btn btn-dk btn-sm" id="sv-rodari" style="display:none;margin-top:5px" onclick="saveEdit('rodari')">Guardar</button>
        <div class="sb-example"><div class="sb-ex-lbl">EJEMPLO</div><p class="sb-text sb-italic" id="ex-rodari"></p></div>
      </div>
      <div class="stab-panel" id="stab-campbell">
        <div class="sec-lbl">CAMPBELL ¬∑ H√âROE DE LAS MIL CARAS<span class="edit-btn" onclick="toggleEdit('campbell')">‚úé editar</span></div>
        <p class="sb-text" id="txt-campbell"></p>
        <textarea class="edit-area" id="ea-campbell" rows="3"></textarea>
        <button class="btn btn-dk btn-sm" id="sv-campbell" style="display:none;margin-top:5px" onclick="saveEdit('campbell')">Guardar</button>
        <div class="sb-example"><div class="sb-ex-lbl">EJEMPLO</div><p class="sb-text sb-italic" id="ex-campbell"></p></div>
      </div>
      <div class="stab-panel" id="stab-config">
        <div class="cfg-section">
          <div class="cfg-head">FASE NARRATIVA</div>
          <div class="cfg-body">
            <p>Cambia el grupo al que pertenece esta carta en la Baraja.</p>
            <select id="phase-sel" style="width:100%;background:var(--paper);border:2px solid var(--ink);color:var(--black);font-family:'Cinzel',serif;font-size:10px;padding:6px 8px;height:36px;letter-spacing:0.5px">
              <option value="inicio">üü¢ Principio</option>
              <option value="nudo">üü† Nudo</option>
              <option value="desenlace">üîµ Desenlace</option>
            </select>
            <button class="btn btn-dk btn-sm" style="margin-top:6px" onclick="savePhase()">Guardar fase</button>
          </div>
        </div>
        <div class="cfg-section">
          <div class="cfg-head">IM√ÅGENES DE LA CARTA</div>
          <div class="cfg-body">
            <p>Original siempre disponible. A√±ade versiones y elige cu√°l mostrar.</p>
            <label class="file-lbl">&#8593; A√±adir imagen<input type="file" class="file-input" id="img-file" accept="image/*"></label>
            <div class="ver-grid" id="ver-grid"></div>
          </div>
        </div>
        <div class="cfg-section">
          <div class="cfg-head">NOTA PERSONAL</div>
          <div class="cfg-body">
            <textarea class="edit-area" id="ea-notes" rows="4" style="display:block;width:100%" placeholder="Tus notas‚Ä¶"></textarea>
            <button class="btn btn-dk btn-sm" style="margin-top:6px" onclick="saveNotes()">Guardar</button>
          </div>
        </div>
        <div class="cfg-section">
          <div class="cfg-head">EXPORTAR</div>
          <div class="cfg-body">
            <button class="btn btn-dk btn-sm" onclick="exportData()">&#8595; Exportar JSON</button>
          </div>
        </div>
      </div>
    </div>
    <div id="sb-empty">
      <img id="sb-logo" src="" alt="">
      <p>HAZ CLIC EN UNA CARTA<br>PARA VER SU<br>FUNCI√ìN NARRATIVA</p>
    </div>
  </div><!-- end sidebar -->

  <!-- MONOMITO SIDEBAR ‚Äî sibling of #sidebar inside #main -->
  <div id="sb-monomito">
    <div id="sb-mm-head">
      <div id="mm-stage-num-label"></div>
      <div id="mm-stage-name-label"></div>
    </div>
    <div id="sb-mm-body">
      <div id="monomito-empty"><p>HAZ CLIC EN UN<br>SEGMENTO DE LA RUEDA</p></div>
      <div id="monomito-detail">
        <p id="mm-stage-desc" style="font-family:'EB Garamond',serif;font-size:14px;line-height:1.7;color:var(--ink);margin-bottom:10px"></p>
        <div id="mm-stage-example" style="font-family:'EB Garamond',serif;font-size:13px;font-style:italic;color:var(--ink-lt);padding:6px 10px;border-left:3px solid var(--rule);margin-bottom:12px"></div>
        <div class="cfg-section">
          <div class="cfg-head">TU NARRATIVA <span class="edit-btn" onclick="toggleMMEdit()">‚úé editar</span></div>
          <div class="cfg-body">
            <p id="mm-user-text" style="font-family:'EB Garamond',serif;font-size:14px;color:var(--ink);line-height:1.6;min-height:30px"></p>
            <textarea id="mm-edit-area" class="edit-area" rows="4" placeholder="Escribe tu versi√≥n de esta etapa‚Ä¶"></textarea>
            <button class="btn btn-dk btn-sm" id="mm-save-btn" style="display:none;margin-top:5px" onclick="saveMMText()">Guardar</button>
          </div>
        </div>
        <div class="cfg-section">
          <div class="cfg-head">FUNCIONES PROPP ASOCIADAS</div>
          <div class="cfg-body">
            <div id="mm-propp-cards" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"></div>
          </div>
        </div>
      </div>
    </div>
  </div><!-- end sb-monomito -->

</div><!-- end main -->

<div id="floater"><img id="floater-img" src="" alt=""></div>

<div id="add-modal">
  <div id="add-modal-box">
    <h2>Nueva Carta</h2>
    <div class="modal-field"><label>T√çTULO</label><input type="text" id="new-title" placeholder="Ej: Revelaci√≥n"></div>
    <div class="modal-field"><label>DESCRIPCI√ìN (PROPP)</label><textarea id="new-propp" placeholder="Descripci√≥n seg√∫n Propp‚Ä¶"></textarea></div>
    <div class="modal-field"><label>RODARI</label><textarea id="new-rodari" placeholder="Interpretaci√≥n creativa‚Ä¶"></textarea></div>
    <div class="modal-field"><label>CAMPBELL</label><input type="text" id="new-campbell" placeholder="El H√©roe de las Mil Caras‚Ä¶"></div>
    <div class="modal-field"><label>EJEMPLO</label><input type="text" id="new-example" placeholder="Ejemplo cl√°sico‚Ä¶"></div>
    <div class="modal-field"><label>IMAGEN (opcional)</label>
      <label class="file-lbl">&#8593; Subir imagen<input type="file" class="file-input" id="new-img" accept="image/*"></label>
      <span id="new-img-name" style="font-family:Cinzel,serif;font-size:9px;color:var(--ink-lt);margin-left:10px"></span>
    </div>
    <div class="modal-actions">
      <button class="btn btn-lt" onclick="closeAddModal()">Cancelar</button>
      <button class="btn btn-dk" onclick="addNewCard()">‚ú¶ A√±adir al mazo</button>
    </div>
  </div>
</div>

<script>
const CARD_IMAGES = {
  "aceptacion": "aceptacion.png",
  "alejamiento": "alejamiento.png",
  "boda": "boda.png",
  "carencia": "carencia.png",
  "castigo": "castigo.png",
  "combate": "combate.png",
  "complicidad": "complicidad.png",
  "da√±o": "dano.png",
  "desenmascaramiento": "desenmascaramiento.png",
  "desobediencia": "desobediencia.png",
  "disfraz": "disfraz.png",
  "donacion": "donacion.png",
  "enga√±o": "engano.png",
  "exito": "exito.png",
  "fracaso": "fracaso.png",
  "informacion": "informacion.png",
  "interrogatorio": "interrogatorio.png",
  "mediacion": "mediacion.png",
  "partida": "partida.png",
  "persecucion": "persecucion.png",
  "prohibicion": "prohibicion.png",
  "reaccion": "reaccion.png",
  "reconocimiento": "reconocimiento.png",
  "regreso": "regreso.png",
  "socorro": "socorro.png",
  "solucion": "solucion.png",
  "sorpresa": "sorpresa.png",
  "tarea": "tarea.png",
  "trampa": "trampa.png",
  "viaje": "viaje.png",
  "marca": "marca.png",
};

const CARDS_DATA = [
  { id: "aceptacion", title: "Aceptaci√≥n", propp: "Decisi√≥n del h√©roe de actuar (counteraction).", rodari: "Momento en que el personaje asume la misi√≥n; la historia pasa de posibilidad a acci√≥n.", campbell: "Aceptaci√≥n del llamado.", example: "Caperucita acepta llevar la cesta a su abuela." },
  { id: "alejamiento", title: "Alejamiento", propp: "Ausencia o salida del hogar.", rodari: "Ruptura del equilibrio inicial.", campbell: "Separaci√≥n.", example: "Hansel y Gretel son abandonados en el bosque." },
  { id: "boda", title: "Boda", propp: "Recompensa final.", rodari: "Restituci√≥n social.", campbell: "Retorno con el elixir.", example: "Cenicienta se casa con el pr√≠ncipe." },
  { id: "carencia", title: "Carencia", propp: "Falta inicial.", rodari: "Motor del deseo narrativo.", campbell: "Llamado a la aventura.", example: "El padre pobre necesita riqueza en Juan y las habichuelas m√°gicas." },
  { id: "castigo", title: "Castigo", propp: "Sanci√≥n del villano.", rodari: "Cierre moral del conflicto.", campbell: "Restablecimiento del orden.", example: "La madrastra de Blancanieves es castigada." },
  { id: "combate", title: "Combate", propp: "Lucha h√©roe-villano.", rodari: "Enfrentamiento decisivo.", campbell: "Ordal√≠a.", example: "San Jorge mata al drag√≥n." },
  { id: "complicidad", title: "Complicidad", propp: "La v√≠ctima ayuda al villano sin saberlo.", rodari: "Ingenuidad que permite el da√±o.", campbell: "Tentaci√≥n.", example: "Caperucita dice al lobo d√≥nde vive la abuela." },
  { id: "da√±o", title: "Da√±o", propp: "Fechor√≠a del villano.", rodari: "Herida narrativa.", campbell: "Crisis inicial.", example: "El lobo devora a la abuela." },
  { id: "desenmascaramiento", title: "Desenmascaramiento", propp: "Exposici√≥n del villano o falso h√©roe.", rodari: "Ca√≠da de la apariencia y revelaci√≥n de la verdad oculta del antagonista o situaci√≥n.", campbell: "Revelaci√≥n final.", example: "En El gato con botas, el ogro se transforma en rat√≥n y queda expuesta su vulnerabilidad esencial; su poder depend√≠a de su forma." },
  { id: "desobediencia", title: "Desobediencia", propp: "Violaci√≥n de la prohibici√≥n.", rodari: "Transgresi√≥n que abre la aventura.", campbell: "Cruce del umbral.", example: "La esposa de Barba Azul abre la puerta prohibida." },
  { id: "disfraz", title: "Disfraz", propp: "Llegada de inc√≥gnito.", rodari: "Identidad oculta.", campbell: "H√©roe desconocido.", example: "Odiseo vuelve disfrazado de mendigo." },
  { id: "donacion", title: "Donaci√≥n", propp: "Recepci√≥n del objeto m√°gico.", rodari: "Ayuda transformadora.", campbell: "Encuentro con el mentor.", example: "El hada madrina ayuda a Cenicienta." },
  { id: "enga√±o", title: "Enga√±o", propp: "Truco del villano.", rodari: "Manipulaci√≥n narrativa.", campbell: "Tentaci√≥n.", example: "El lobo se disfraza de abuela." },
  { id: "exito", title: "√âxito", propp: "Victoria.", rodari: "Logro del objetivo.", campbell: "Recompensa.", example: "El cazador libera a Caperucita y la abuela." },
  { id: "fracaso", title: "Fracaso", propp: "Intento fallido o derrota provisional.", rodari: "Error productivo que obliga a reintentar o aprender.", campbell: "Pruebas fallidas.", example: "En Los tres cerditos, las casas de paja y madera fracasan antes de la de ladrillo." },
  { id: "informacion", title: "Informaci√≥n", propp: "El villano obtiene datos.", rodari: "Conocimiento peligroso o revelador.", campbell: "Revelaci√≥n parcial.", example: "El lobo averigua d√≥nde vive la abuela." },
  { id: "interrogatorio", title: "Interrogatorio", propp: "Reconocimiento del villano (investigaci√≥n).", rodari: "Obtenci√≥n activa de informaci√≥n mediante preguntas o indagaci√≥n.", campbell: "B√∫squeda.", example: "El lobo pregunta a Caperucita d√≥nde vive la abuela." },
  { id: "mediacion", title: "Mediaci√≥n", propp: "Se conoce la carencia.", rodari: "Anuncio de la misi√≥n.", campbell: "Llamado.", example: "El rey anuncia la desaparici√≥n de la princesa." },
  { id: "partida", title: "Partida", propp: "Salida del h√©roe.", rodari: "Inicio del viaje.", campbell: "Cruce del umbral.", example: "El pr√≠ncipe parte en busca de la princesa." },
  { id: "persecucion", title: "Persecuci√≥n", propp: "El h√©roe es perseguido.", rodari: "Tensi√≥n del retorno.", campbell: "Huida.", example: "El gigante persigue a Juan." },
  { id: "prohibicion", title: "Prohibici√≥n", propp: "Regla impuesta.", rodari: "L√≠mite que provoca curiosidad.", campbell: "Advertencia del llamado.", example: "No hables con extra√±os en Caperucita." },
  { id: "reaccion", title: "Reacci√≥n", propp: "Respuesta del h√©roe a la prueba del donante.", rodari: "Acci√≥n que revela el car√°cter del h√©roe y determina si merece ayuda.", campbell: "Prueba del h√©roe.", example: "Cenicienta ayuda a los animales; luego ellos la ayudan a ella." },
  { id: "reconocimiento", title: "Reconocimiento", propp: "El h√©roe es reconocido.", rodari: "Validaci√≥n social.", campbell: "Reconocimiento.", example: "La zapatilla encaja en Cenicienta." },
  { id: "regreso", title: "Regreso", propp: "Retorno del h√©roe.", rodari: "Vuelta transformada.", campbell: "Retorno.", example: "Odiseo regresa a √çtaca." },
  { id: "socorro", title: "Socorro", propp: "Rescate del h√©roe.", rodari: "Ayuda salvadora.", campbell: "Ayuda sobrenatural.", example: "Los p√°jaros ayudan a Cenicienta." },
  { id: "solucion", title: "Soluci√≥n", propp: "Resoluci√≥n de la tarea.", rodari: "Inteligencia final.", campbell: "Superaci√≥n.", example: "Adivinar el nombre en Rumpelstiltskin." },
  { id: "sorpresa", title: "Sorpresa", propp: "Elemento inesperado.", rodari: "Giro de maravilla.", campbell: "Revelaci√≥n s√∫bita.", example: "El ogro puede transformarse en animales." },
  { id: "tarea", title: "Tarea", propp: "Tarea dif√≠cil.", rodari: "Desaf√≠o estructural.", campbell: "Pruebas.", example: "Separar granos en Cenicienta." },
  { id: "trampa", title: "Trampa", propp: "Enga√±o contra el h√©roe.", rodari: "Obst√°culo deliberado.", campbell: "Obst√°culo.", example: "La manzana envenenada de Blancanieves." },
  { id: "viaje", title: "Viaje", propp: "Desplazamiento entre mundos.", rodari: "Tr√°nsito imaginativo.", campbell: "Camino de pruebas.", example: "Pulgarcito atraviesa el bosque." },
  { id: "marca", title: "Marca", propp: "El h√©roe recibe una se√±al distintiva ‚Äîherida, cicatriz, sello, anillo, objeto √∫nico‚Äî que queda ligada a su identidad y servir√° m√°s adelante como prueba material de reconocimiento o de lo vivido.", rodari: "Motor l√∫dico: la marca puede ser una palabra pegadiza, un tic, un apodo, un objeto absurdo o una huella de imaginaci√≥n que reaparece como leitmotiv. Tambi√©n puede subvertirse: la marca se falsifica, todos la llevan, o cambia de sitio, generando humor, giro o cr√≠tica.", campbell: "Equivale a la herida del h√©roe o al don obtenido tras las Pruebas y el encuentro con el mentor: un cambio visible (cicatriz, estigma, objeto, t√≠tulo) que evidencia la transformaci√≥n y act√∫a como trofeo que autentifica el viaje en el Retorno.", example: "Ulises es reconocido por la cicatriz del jabal√≠. Frodo lleva el dedo amputado. Caperucita guarda la piedra en el vientre del lobo como prueba." },
];

const LOGO_IMG = "logo_promppt.png";


const NARRATIVE_GROUPS={
  inicio:['alejamiento','prohibicion','desobediencia','interrogatorio','informacion','engano','complicidad','dano','carencia'],
  nudo:['mediacion','aceptacion','partida','viaje','marca','tarea','reaccion','donacion','trampa','fracaso','socorro','combate','exito','solucion','sorpresa'],
  desenlace:['persecucion','regreso','disfraz','reconocimiento','desenmascaramiento','castigo','boda']
};
function normId(s){return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z]/g,'');}
const PHASE={};
Object.entries(NARRATIVE_GROUPS).forEach(([ph,ids])=>ids.forEach(id=>PHASE[id]=ph));
function getPhase(id){const n=normId(id);return PHASE[n]||PHASE[Object.keys(PHASE).find(k=>normId(k)===n)]||null;}

['deck-logo','hint-logo','sb-logo','corner-logo'].forEach(id=>{const el=document.getElementById(id);if(el)el.src=LOGO_IMG;});

let deck=[],timeline=[],selectedCard=null,verIdx={};
let rtEnabled=false,rtTimeout=null,rtPending=false,isGen=false,curStory=null;
let custom={},spreadOpen=false,spreadView='all';
let newCardImg=null;

function loadC(){try{const d=sessionStorage.getItem('ppc9');if(d)custom=JSON.parse(d);}catch(e){}}
function saveC(){try{sessionStorage.setItem('ppc9',JSON.stringify(custom));}catch(e){}}

function init(){
  loadC();deck=[...CARDS_DATA,...(custom.__extra||[])];shuffle(deck);
  timeline=[];selectedCard=null;spreadOpen=false;
  renderDeck();renderTL();updateSeq();
  document.getElementById('sb-content').style.display='none';
  document.getElementById('sb-empty').style.display='flex';
  document.getElementById('table-hint').classList.remove('hidden');
  document.getElementById('card-preview').classList.remove('visible');
  resetStory();showTab('card');curStory=null;
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
document.querySelectorAll('.ttab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.panel)));
function showTab(n){
  document.querySelectorAll('.ttab').forEach(t=>t.classList.toggle('active',t.dataset.panel===n));
  document.querySelectorAll('.tpanel').forEach(p=>p.classList.toggle('active',p.id==='panel-'+n));
  const isMM=(n==='monomito');
  const sidebar = document.getElementById('sidebar');
  const sbMM    = document.getElementById('sb-monomito');
  if(isMM){
    sidebar.style.display = 'none';
    sbMM.style.display    = 'flex';
  }else{
    sidebar.style.display = 'flex';
    sbMM.style.display    = 'none';
  }
  // Carta/Baraja ‚Üí always Propp timeline
  // Monomito ‚Üí always MM timeline
  // Relato ‚Üí follow storySrc
  let showMM;
  if(n==='card' || n==='spread'){
    showMM = false;
  } else if(n==='monomito'){
    showMM = true;
  } else { // story
    showMM = (typeof storySrc!=='undefined' && storySrc==='monomito');
  }
  document.getElementById('tl').style.display    = showMM ? 'none' : '';
  document.getElementById('tl-mm').style.display = showMM ? 'flex' : 'none';
  document.getElementById('tl-label').textContent = showMM ? 'L√çNEA MONOMITO' : 'L√çNEA NARRATIVA';
}
document.querySelectorAll('.stab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.stab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.stab-panel').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');document.getElementById('stab-'+t.dataset.stab).classList.add('active');
}));

// ‚îÄ‚îÄ DECK ‚îÄ‚îÄ
function renderDeck(){
  document.getElementById('deck-count').textContent=deck.length;
  document.getElementById('deck-logo').style.opacity=deck.length===0?'0.08':'0.35';
  document.getElementById('deck-top').style.cursor=deck.length===0?'default':'grab';
}
document.getElementById('deck-top').addEventListener('mousedown',e=>{
  if(deck.length===0)return;e.preventDefault();
  startDrag({type:'deck',card:deck[deck.length-1]},e.clientX,e.clientY);
});

function getImg(id){
  const c=custom[id],vi=verIdx[id]||0;
  if(vi>0&&c&&c.versions&&c.versions[vi-1])return c.versions[vi-1].src;
  if(c&&c.origImg)return c.origImg;
  return CARD_IMAGES[id]||'';
}
function getVerTotal(id){return 1+((custom[id]&&custom[id].versions&&custom[id].versions.length)||0);}

// ‚îÄ‚îÄ DRAG: movement > 6px = drag, else = click ‚îÄ‚îÄ
function startDrag(src,sx,sy){
  let moved=false;
  const f=document.getElementById('floater'),fi=document.getElementById('floater-img');
  function onMove(e){
    const dx=e.clientX-sx,dy=e.clientY-sy;
    if(!moved&&Math.sqrt(dx*dx+dy*dy)>6){
      moved=true;fi.src=getImg(src.card.id);f.style.display='block';
      if(src.type==='tl'){
        const cards=document.getElementById('tl').querySelectorAll('.tl-slot.occupied .tl-card');
        if(cards[src.idx])cards[src.idx].classList.add('dragging');
      }
    }
    if(moved){f.style.left=(e.clientX-40)+'px';f.style.top=(e.clientY-58)+'px';hlDrop(e.clientX,e.clientY);}
  }
  function onUp(e){
    document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);
    f.style.display='none';clrHL();
    if(moved){
      const idx=dropIdx(e.clientX,e.clientY);
      if(idx!==null){
        if(src.type==='deck')placeDeck(src.card,idx);
        else if(src.type==='tl')reorder(src.idx,idx);
        else if(src.type==='spread')placeFromSpread(src.card,idx);
      } else if(src.type==='tl'){
        const r=document.getElementById('tl-wrap').getBoundingClientRect();
        if(e.clientY<r.top-30)returnCard(src.idx);else renderTL();
      }
    } else {
      selectCard(src.card);showTab('card');
    }
  }
  document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);
}

function placeDeck(card,idx){
  const di=deck.findIndex(c=>c.id===card.id);if(di!==-1)deck.splice(di,1);
  timeline.splice(idx,0,{...card,iid:Date.now()+Math.random()});
  renderDeck();renderTL();updateSeq();renderSpread();selectCard(card);updateHint();
  if(rtEnabled)schedRT();
}
function placeFromSpread(card,idx){
  const di=deck.findIndex(c=>c.id===card.id);if(di!==-1)deck.splice(di,1);
  const ti=timeline.findIndex(c=>c.id===card.id);if(ti!==-1)timeline.splice(ti,1);
  timeline.splice(idx,0,{...card,iid:Date.now()+Math.random()});
  renderDeck();renderTL();updateSeq();renderSpread();selectCard(card);updateHint();
  if(rtEnabled)schedRT();
}

// ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ
function renderTL(){
  const tl=document.getElementById('tl');tl.innerHTML='';tl.appendChild(mkI(0));
  timeline.forEach((card,idx)=>{
    const slot=document.createElement('div');slot.className='tl-slot occupied';
    const ce=document.createElement('div');ce.className='tl-card'+(selectedCard&&selectedCard.id===card.id?' selected':'');
    const num=document.createElement('div');num.className='card-num';num.textContent=idx+1;
    const img=document.createElement('img');img.src=getImg(card.id);img.alt=card.title;
    const del=document.createElement('button');del.className='card-del';del.textContent='‚úï';
    del.addEventListener('mousedown',e=>e.stopPropagation());
    del.addEventListener('click',e=>{e.stopPropagation();returnCard(idx);});
    ce.appendChild(num);ce.appendChild(img);ce.appendChild(del);
    ce.addEventListener('mousedown',e=>{if(e.target===del)return;e.preventDefault();startDrag({type:'tl',idx,card},e.clientX,e.clientY);});
    slot.appendChild(ce);tl.appendChild(slot);tl.appendChild(mkI(idx+1));
  });
  if(timeline.length<30){const e=document.createElement('div');e.className='tl-slot';e.innerHTML='<span style="font-size:16px;color:var(--rule)">+</span>';tl.appendChild(e);}
}
function mkI(pos){const e=document.createElement('div');e.className='drop-ind';e.dataset.pos=pos;return e;}
function dropIdx(x,y){
  const r=document.getElementById('tl-wrap').getBoundingClientRect();
  if(x<r.left||x>r.right||y<r.top||y>r.bottom)return null;
  const inds=document.getElementById('tl').querySelectorAll('.drop-ind');
  let best=null,bd=Infinity;
  inds.forEach(i=>{const cr=i.getBoundingClientRect();const d=Math.abs(x-(cr.left+cr.width/2));if(d<bd){bd=d;best=i;}});
  return best?parseInt(best.dataset.pos):timeline.length;
}
function hlDrop(x,y){clrHL();const i=dropIdx(x,y);if(i===null)return;document.getElementById('tl').querySelectorAll('.drop-ind').forEach(e=>{if(parseInt(e.dataset.pos)===i)e.classList.add('active');});}
function clrHL(){document.getElementById('tl').querySelectorAll('.drop-ind').forEach(e=>e.classList.remove('active'));}
function reorder(from,to){
  if(from===to||from===to-1){renderTL();return;}
  const c=timeline.splice(from,1)[0];timeline.splice(to>from?to-1:to,0,c);
  renderTL();updateSeq();renderSpread();if(rtEnabled)schedRT();
}
function returnCard(idx){
  deck.push(timeline.splice(idx,1)[0]);
  renderDeck();renderTL();updateSeq();updateHint();renderSpread();
  if(rtEnabled&&timeline.length>0)schedRT();
}
function updateHint(){document.getElementById('table-hint').classList.toggle('hidden',timeline.length>0);}

// ‚îÄ‚îÄ SPREAD ‚îÄ‚îÄ
document.getElementById('btn-spread').addEventListener('click',()=>{
  spreadOpen=!spreadOpen;
  document.getElementById('btn-spread').textContent=spreadOpen?'‚äû Ocultar':'‚äû Baraja';
  if(spreadOpen){renderSpread();showTab('spread');}else showTab('card');
});
function setSpreadView(phase){
  spreadView=phase;
  document.querySelectorAll('.ssb').forEach(b=>b.classList.toggle('active',b.dataset.phase===phase));
  renderSpread();
}
function renderSpread(){
  const grid=document.getElementById('spread-grid');grid.innerHTML='';
  const inTL=new Set(timeline.map(c=>c.id));
  const allCards=[...CARDS_DATA,...(custom.__extra||[])];
  if(spreadView==='order'){
    ['inicio','nudo','desenlace'].forEach(ph=>{
      const cards=allCards.filter(c=>getPhase(c.id)===ph);
      if(cards.length)appendSpreadSection(grid,ph,cards,inTL);
    });
    const others=allCards.filter(c=>!getPhase(c.id));
    if(others.length)appendSpreadSection(grid,null,others,inTL);
  } else if(spreadView==='all'){
    const row=document.createElement('div');row.className='spread-cards-row';row.style.justifyContent='center';
    allCards.forEach(card=>row.appendChild(makeSpreadCard(card,inTL)));
    grid.appendChild(row);
  } else {
    const cards=allCards.filter(c=>getPhase(c.id)===spreadView);
    const row=document.createElement('div');row.className='spread-cards-row';row.style.justifyContent='center';
    cards.forEach(card=>row.appendChild(makeSpreadCard(card,inTL)));
    grid.appendChild(row);
  }
}
function appendSpreadSection(grid,phase,cards,inTL){
  const labels={inicio:'üü¢ Principio ‚Äî preparaci√≥n y ruptura del equilibrio',nudo:'üü† Nudo ‚Äî misi√≥n, pruebas, confrontaci√≥n',desenlace:'üîµ Desenlace ‚Äî retorno, reconocimiento, restituci√≥n'};
  const sec=document.createElement('div');sec.className='spread-section';
  const stitle=document.createElement('div');stitle.className='spread-section-title';stitle.textContent=labels[phase]||'Otras cartas';
  sec.appendChild(stitle);
  const row=document.createElement('div');row.className='spread-cards-row';
  cards.forEach(card=>row.appendChild(makeSpreadCard(card,inTL)));
  sec.appendChild(row);grid.appendChild(sec);
}
function makeSpreadCard(card,inTL){
  const div=document.createElement('div');div.className='spread-card'+(inTL.has(card.id)?' in-tl':'');
  div.title=card.title+(inTL.has(card.id)?' (en l√≠nea)':'');
  const img=document.createElement('img');img.src=getImg(card.id);img.alt=card.title;
  const lbl=document.createElement('div');lbl.className='spread-card-name';lbl.textContent=card.title;
  div.appendChild(img);div.appendChild(lbl);
  div.addEventListener('mousedown',e=>{e.preventDefault();startDrag({type:'spread',card},e.clientX,e.clientY);});
  return div;
}

// ‚îÄ‚îÄ SEQ ‚îÄ‚îÄ
function updateSeq(){
  const el=document.getElementById('seq');
  if(!el)return;
  if(timeline.length===0){el.innerHTML='<span class="empty">Arrastra cartas a la l√≠nea narrativa‚Ä¶</span>';return;}
  el.innerHTML=timeline.map((c,i)=>(i>0?'<span class="sep">‚Üí</span>':'')+
    '<span style="color:var(--ink)">'+c.title.toUpperCase()+'</span>').join('');
}

// ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ
function selectCard(card){selectedCard=card;renderTL();showSidebar(card);showPreview(card);}
function showPreview(card){
  document.getElementById('card-preview-img').src=getImg(card.id);
  document.getElementById('card-preview-title').textContent=card.title;
  const total=getVerTotal(card.id);const nav=document.getElementById('ver-nav');
  if(total>1){nav.style.display='flex';document.getElementById('ver-lbl').textContent=((verIdx[card.id]||0)+1)+'/'+total;}
  else nav.style.display='none';
  document.getElementById('card-preview').classList.add('visible');
}
document.getElementById('card-preview-img').addEventListener('click',()=>{if(selectedCard)cycleVer(1);});
function cycleVer(dir){
  if(!selectedCard)return;const total=getVerTotal(selectedCard.id);
  verIdx[selectedCard.id]=((verIdx[selectedCard.id]||0)+dir+total)%total;
  showPreview(selectedCard);renderTL();
}
function showSidebar(card){
  document.getElementById('sb-empty').style.display='none';
  document.getElementById('sb-content').style.display='flex';
  document.getElementById('sb-title').textContent=card.title;
  document.getElementById('sb-sub').textContent='FUNCI√ìN NARRATIVA ¬∑ RODARI/PROPP';
  const c=custom[card.id]||{};
  document.getElementById('txt-propp').textContent=c.propp||card.propp;
  document.getElementById('txt-rodari').textContent=c.rodari||card.rodari;
  document.getElementById('txt-campbell').textContent=c.campbell||card.campbell;
  ['propp','rodari','campbell'].forEach(k=>{
    document.getElementById('ex-'+k).textContent=c.example||card.example;
    document.getElementById('ea-'+k).style.display='none';
    document.getElementById('sv-'+k).style.display='none';
  });
  document.getElementById('ea-notes').value=c.notes||'';renderVerGrid(card.id);
  // Update phase selector
  const ph=getPhase(card.id)||'inicio';
  const psel=document.getElementById('phase-sel');if(psel)psel.value=ph;
}

// ‚îÄ‚îÄ EDIT ‚îÄ‚îÄ
function toggleEdit(f){
  const ea=document.getElementById('ea-'+f),sv=document.getElementById('sv-'+f),tx=document.getElementById('txt-'+f);
  if(ea.style.display==='block'){ea.style.display='none';sv.style.display='none';}
  else{ea.value=tx.textContent;ea.style.display='block';sv.style.display='inline-block';ea.focus();}
}
function saveEdit(f){
  if(!selectedCard)return;const v=document.getElementById('ea-'+f).value.trim();
  if(!custom[selectedCard.id])custom[selectedCard.id]={};
  custom[selectedCard.id][f]=v;saveC();
  document.getElementById('txt-'+f).textContent=v;
  document.getElementById('ea-'+f).style.display='none';document.getElementById('sv-'+f).style.display='none';
}
function saveNotes(){
  if(!selectedCard)return;if(!custom[selectedCard.id])custom[selectedCard.id]={};
  custom[selectedCard.id].notes=document.getElementById('ea-notes').value.trim();saveC();
}

// ‚îÄ‚îÄ IMAGE VERSIONS ‚îÄ‚îÄ
document.getElementById('img-file').addEventListener('change',function(){
  if(!selectedCard||!this.files[0])return;const reader=new FileReader();
  reader.onload=e=>{
    if(!custom[selectedCard.id])custom[selectedCard.id]={};
    if(!custom[selectedCard.id].versions)custom[selectedCard.id].versions=[];
    custom[selectedCard.id].versions.push({src:e.target.result});
    verIdx[selectedCard.id]=custom[selectedCard.id].versions.length;
    saveC();renderVerGrid(selectedCard.id);showPreview(selectedCard);renderTL();
  };reader.readAsDataURL(this.files[0]);this.value='';
});
function renderVerGrid(id){
  const grid=document.getElementById('ver-grid');grid.innerHTML='';
  const c=custom[id];
  const ot=document.createElement('div');ot.className='ver-thumb'+((verIdx[id]||0)===0?' cur':'');ot.title='Original';
  const oi=document.createElement('img');oi.src=c&&c.origImg?c.origImg:(CARD_IMAGES[id]||'');oi.alt='orig';
  const on=document.createElement('div');on.className='ver-num';on.textContent='orig';
  ot.appendChild(oi);ot.appendChild(on);
  ot.addEventListener('click',()=>{verIdx[id]=0;renderVerGrid(id);showPreview(selectedCard);renderTL();});
  grid.appendChild(ot);
  if(c&&c.versions&&c.versions.length){
    c.versions.forEach((v,i)=>{
      const cur=(verIdx[id]||0)===i+1;const t=document.createElement('div');t.className='ver-thumb'+(cur?' cur':'');
      const img=document.createElement('img');img.src=v.src;img.alt='v'+(i+1);
      const num=document.createElement('div');num.className='ver-num';num.textContent=i+1;
      const del=document.createElement('button');del.className='ver-del';del.textContent='‚úï';
      del.addEventListener('click',ev=>{ev.stopPropagation();delVer(id,i);});
      t.appendChild(img);t.appendChild(num);t.appendChild(del);
      t.addEventListener('click',()=>{verIdx[id]=i+1;renderVerGrid(id);showPreview(selectedCard);renderTL();});
      grid.appendChild(t);
    });
  }
}
function delVer(id,idx){
  custom[id].versions.splice(idx,1);if((verIdx[id]||0)>custom[id].versions.length)verIdx[id]=0;
  saveC();renderVerGrid(id);if(selectedCard&&selectedCard.id===id){showPreview(selectedCard);renderTL();}
}
function exportData(){
  const out={};CARDS_DATA.forEach(c=>{const cu=custom[c.id]||{};out[c.id]={title:c.title,propp:cu.propp||c.propp,rodari:cu.rodari||c.rodari,campbell:cu.campbell||c.campbell,example:cu.example||c.example,notes:cu.notes||'',customVersions:(cu.versions||[]).length};});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(out,null,2)],{type:'application/json'}));a.download='mesa_propp_data.json';a.click();
}

// ‚îÄ‚îÄ ADD CARD ‚îÄ‚îÄ
document.getElementById('add-card-btn').addEventListener('click',()=>document.getElementById('add-modal').classList.add('open'));
document.getElementById('add-modal').addEventListener('click',e=>{if(e.target===document.getElementById('add-modal'))closeAddModal();});
document.getElementById('new-img').addEventListener('change',function(){
  if(!this.files[0])return;const reader=new FileReader();
  reader.onload=e=>{newCardImg=e.target.result;};reader.readAsDataURL(this.files[0]);
  document.getElementById('new-img-name').textContent=this.files[0].name;
});
function closeAddModal(){
  document.getElementById('add-modal').classList.remove('open');
  ['new-title','new-propp','new-rodari','new-campbell','new-example'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('new-img-name').textContent='';newCardImg=null;
}
function addNewCard(){
  const title=document.getElementById('new-title').value.trim();if(!title){alert('El t√≠tulo es obligatorio');return;}
  const id='custom_'+Date.now();
  const newCard={id,title,propp:document.getElementById('new-propp').value.trim()||'Funci√≥n personalizada.',rodari:document.getElementById('new-rodari').value.trim()||'',campbell:document.getElementById('new-campbell').value.trim()||'',example:document.getElementById('new-example').value.trim()||''};
  if(newCardImg){if(!custom[id])custom[id]={};custom[id].origImg=newCardImg;}
  if(!custom.__extra)custom.__extra=[];custom.__extra.push(newCard);deck.push(newCard);
  saveC();renderDeck();renderSpread();closeAddModal();selectCard(newCard);showTab('card');
}

// ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ
document.getElementById('btn-shuffle').addEventListener('click',()=>{
  shuffle(deck);const s=document.getElementById('deck-stack');
  s.classList.remove('shuffling');void s.offsetWidth;s.classList.add('shuffling');
  setTimeout(()=>s.classList.remove('shuffling'),620);renderDeck();
});
document.getElementById('btn-reset').addEventListener('click',()=>{
  deck=[...CARDS_DATA,...(custom.__extra||[])];shuffle(deck);timeline=[];selectedCard=null;spreadOpen=false;
  renderDeck();renderTL();updateSeq();updateHint();
  document.getElementById('sb-content').style.display='none';document.getElementById('sb-empty').style.display='flex';
  document.getElementById('card-preview').classList.remove('visible');
  resetStory();showTab('card');curStory=null;document.getElementById('btn-spread').textContent='‚äû Baraja';
});
document.getElementById('btn-compose').addEventListener('click',()=>genStory(false));
document.getElementById('btn-clear').addEventListener('click',()=>{resetStory();curStory=null;});
document.getElementById('rt-sw').addEventListener('change',function(){
  rtEnabled=this.checked;document.getElementById('rt-status').classList.toggle('on',rtEnabled);
  if(rtEnabled&&timeline.length>0)schedRT();
});

let storySrc='propp'; // 'propp' | 'monomito'
function setStorySrc(src){
  storySrc=src;
  document.getElementById('src-propp-btn').classList.toggle('active',src==='propp');
  document.getElementById('src-mm-btn').classList.toggle('active',src==='monomito');
  // Show/hide the right timeline strip WITHOUT changing the main panel tab
  document.getElementById('tl').style.display        = src==='monomito' ? 'none' : '';
  document.getElementById('tl-mm').style.display     = src==='monomito' ? 'flex' : 'none';
  document.getElementById('tl-label').textContent    = src==='monomito' ? 'L√çNEA MONOMITO' : 'L√çNEA NARRATIVA';
  // Update placeholder text
  const ph=document.getElementById('story-placeholder');
  if(ph){
    ph.innerHTML=src==='monomito'
      ? 'Ordena los segmentos en la l√≠nea del Monomito y pulsa <em>Componer</em>.<br><small style="font-size:12px;opacity:0.5;display:block;margin-top:10px">El Viaje del H√©roe seg√∫n Campbell.</small>'
      : 'Coloca funciones en la secuencia narrativa y pulsa <em>Componer</em>.<br><small style="font-size:12px;opacity:0.5;display:block;margin-top:10px">Gram√°tica creativa seg√∫n Rodari sobre Propp.</small>';
  }
}

// ‚îÄ‚îÄ STORY ‚îÄ‚îÄ
function resetStory(){
  document.getElementById('story-placeholder').style.display='block';
  document.getElementById('story-generating').style.display='none';
  document.querySelectorAll('.story-para').forEach(e=>e.remove());
  document.getElementById('story-moralia').style.display='none';
  document.getElementById('story-funcs').textContent='‚Äî';document.getElementById('story-badge').textContent='‚Äî';
}
function schedRT(){
  clearTimeout(rtTimeout);if(isGen){rtPending=true;return;}
  if(storySrc==='propp'&&timeline.length===0)return;
  if(storySrc==='monomito'&&mmOrder.length===0)return;
  rtTimeout=setTimeout(()=>{if(!isGen)genStory(true);},1200);
}
async function genStory(isRT){
  const src=storySrc||'propp';
  if(src==='monomito'){await genStoryMonomito();return;}
  if(timeline.length===0)return;
  const key=(document.getElementById('api-key').value||'').replace(/[^\x21-\x7E]/g,'').trim();
  const model=document.getElementById('model-sel').value;
  const mode=document.getElementById('mode-sel').value;const isF=mode==='folklore';
  if(!key){showTab('story');document.getElementById('story-placeholder').innerHTML='<span style="color:#8a2020;font-family:Cinzel,serif;font-size:12px">Introduce tu API key en el Scriptorium.</span>';return;}
  const funcs=timeline.map((c,i)=>`${i+1}. ${c.title} ‚Äî ${c.propp}`).join('\n');
  const modeLabel=isF?'FOLKLORE ¬∑ CUENTO':'CONTEMPOR√ÅNEO';
  const styleBlock=isF?'ESTILO: Cuento popular folcl√≥rico. Voz omnisciente atemporal. F√≥rmulas orales. Personajes arquet√≠picos. Mundo m√°gico. Cierra con moraleja expl√≠cita.':'ESTILO: Relato contempor√°neo. Personajes psicol√≥gicos. Ambientaci√≥n concreta. SIN moraleja. Cierre emocionalmente resolutivo.';
  const jsonSchema='{"paragraphs":[{"func":"Nombre funci√≥n","text":"Texto p√°rrafo"}],'+(isF?'"moralia":"texto"':'"moralia":""')+'}';
  let prompt;
  if(isRT&&curStory){prompt='Reescribe esta historia con el NUEVO ORDEN de funciones. Mismos personajes y mundo, trama adaptada.\n\nHISTORIA:\n'+curStory.raw+'\n\nNUEVO ORDEN:\n'+funcs+'\n\n'+styleBlock+'\n\nSOLO JSON:\n'+jsonSchema;}
  else{prompt='Comp√≥n un relato con estas funciones de Propp/Rodari. UN P√ÅRRAFO POR FUNCI√ìN en orden exacto.\n\nFUNCIONES:\n'+funcs+'\n\n- Inicio, desarrollo, cierre completo\n- Personajes con nombres, coherentes\n- NO menciones las funciones\n- 300-420 palabras\n\n'+styleBlock+'\n\nSOLO JSON. RESPONDE √öNICAMENTE CON EL JSON, SIN TEXTO ADICIONAL, SIN BLOQUES DE C√ìDIGO, SIN COMILLAS EXTRAS:\n'+jsonSchema;}
  isGen=true;showTab('story');resetStory();
  document.getElementById('story-placeholder').style.display='none';
  document.getElementById('story-generating').style.display='block';
  document.getElementById('story-funcs').textContent=timeline.map(c=>c.title).join(' ‚Üí ');
  document.getElementById('story-badge').textContent=modeLabel;
  try{
    const raw=await callAI(key,model,prompt,1400,true);
    let parsed;
    try{
      parsed=parseJSON(raw);
      if(!parsed.paragraphs||!Array.isArray(parsed.paragraphs)) throw new Error('missing paragraphs');
    }catch(e){
      document.getElementById('story-generating').style.display='none';
      document.getElementById('story-placeholder').style.display='block';
      document.getElementById('story-placeholder').innerHTML='<span style="color:#8a2020;font-family:Cinzel,serif;font-size:12px">Error procesando respuesta. Int√©ntalo de nuevo o cambia de modelo.</span>';
      isGen=false;if(rtPending&&rtEnabled){rtPending=false;schedRT();}
      return;
    }
    document.getElementById('story-generating').style.display='none';
    const body=document.getElementById('story-body');
    curStory={paragraphs:parsed.paragraphs,moralia:parsed.moralia||'',raw:parsed.paragraphs.map(p=>'['+p.func+']\n'+p.text).join('\n\n')};
    parsed.paragraphs.forEach(p=>{
      const div=document.createElement('div');div.className='story-para';
      if(p.func){const tag=document.createElement('div');tag.className='story-func-tag';tag.textContent=p.func.toUpperCase();div.appendChild(tag);}
      const txt=document.createElement('div');txt.className='story-para-text';txt.textContent=p.text;div.appendChild(txt);
      body.appendChild(div);
    });
    if(isF&&parsed.moralia){document.getElementById('moralia-text').textContent=parsed.moralia;document.getElementById('story-moralia').style.display='block';}
  }catch(err){
    document.getElementById('story-generating').style.display='none';document.getElementById('story-placeholder').style.display='block';
    document.getElementById('story-placeholder').innerHTML='<span style="color:#8a2020;font-family:Cinzel,serif;font-size:12px">Error: '+err.message+'</span>';
  }
  isGen=false;if(rtPending&&rtEnabled){rtPending=false;schedRT();}
}

async function genStoryMonomito(){
  // Don't call loadMM() here ‚Äî use live mmOrder already in memory
  const key=(document.getElementById('api-key').value||'').replace(/[^\x21-\x7E]/g,'').trim();
  const model=document.getElementById('model-sel').value;
  const mode=document.getElementById('mode-sel').value;const isF=mode==='folklore';
  if(!key){showTab('story');document.getElementById('story-placeholder').innerHTML='<span style="color:#8a2020;font-family:Cinzel,serif;font-size:12px">Introduce tu API key en el Scriptorium.</span>';return;}
  // Build ordered stage list ‚Äî use PHASE labels to prevent model reordering based on prior Campbell knowledge
  const orderedStages=mmOrder.map((id,i)=>{
    const s=MONOMITO_STAGES.find(x=>x.id===id);
    const ex=(mmData[id]&&mmData[id].text)||'';
    // Label as FASE N with name as descriptor ‚Äî model must follow FASE order, not name recognition
    return `FASE_${String(i+1).padStart(2,'0')} [${s.name}]${ex?' ‚Äî '+ex:''}`;
  }).join('\n');

  // Build the JSON template with explicit phase keys to lock output order
  const phaseKeys=mmOrder.map((id,i)=>({
    func: `FASE_${String(i+1).padStart(2,'0')}`,
    name: MONOMITO_STAGES.find(s=>s.id===id).name
  }));
  const jsonTemplate='{"paragraphs":[\n'+phaseKeys.map(p=>`  {"func":"${p.name}","text":"ESCRIBE_AQUI_EL_PARRAFO_DE_${p.func}"}`).join(',\n')+'\n]'+(isF?',"moralia":"ESCRIBE_AQUI_LA_MORALEJA"':'')+'}';

  const styleBlock=isF
    ?'ESTILO: Cuento popular folcl√≥rico. Voz omnisciente atemporal. Cierra con moraleja expl√≠cita.'
    :'ESTILO: Relato contempor√°neo. Personajes psicol√≥gicos. SIN moraleja. Cierre emocionalmente resolutivo.';

  const prompt=`Eres un generador de texto estructurado. Tu tarea es rellenar una plantilla JSON con texto narrativo.

REGLA ABSOLUTA: Rellena los campos en el orden exacto en que aparecen. NO cambies el orden de los objetos en el array. Cada objeto "func" corresponde a una fase de la historia y ya est√° ordenado. Solo reemplaza los valores "ESCRIBE_AQUI_..." con el texto narrativo correspondiente.

FASES EN ORDEN (de primera a √∫ltima, sin alteraci√≥n):
${orderedStages}

INSTRUCCIONES DE ESCRITURA:
- Para cada FASE_NN escribe UN p√°rrafo de 35-50 palabras
- Los personajes deben tener nombres propios y ser coherentes entre s√≠
- NO menciones el nombre de la fase en el texto
- El relato debe tener continuidad narrativa entre fases consecutivas
${styleBlock}

PLANTILLA A RELLENAR (devuelve exactamente esta estructura con los textos rellenos):
${jsonTemplate}`;

  isGen=true;showTab('story');resetStory();
  document.getElementById('story-placeholder').style.display='none';
  document.getElementById('story-generating').style.display='block';
  document.getElementById('story-funcs').textContent=mmOrder.map(id=>MONOMITO_STAGES.find(s=>s.id===id).name).join(' ‚Üí ');
  document.getElementById('story-badge').textContent='‚òØ MONOMITO';
  try{
    const raw=await callAI(key,model,prompt,2000,true);
    let parsed;
    try{
      parsed=parseJSON(raw);
      if(!parsed.paragraphs||!Array.isArray(parsed.paragraphs)) throw new Error('missing paragraphs');
      // Clean up placeholder text from template if model left it
      parsed.paragraphs=parsed.paragraphs.map(p=>({func:p.func,text:(p.text||'').replace(/ESCRIBE_AQUI_.*?(\s|$)/g,'').trim()||p.text}));
    }catch(e){
      document.getElementById('story-generating').style.display='none';
      document.getElementById('story-placeholder').style.display='block';
      document.getElementById('story-placeholder').innerHTML='<span style="color:#8a2020;font-family:Cinzel,serif;font-size:12px">Error procesando respuesta. Int√©ntalo de nuevo o cambia de modelo.</span>';
      isGen=false;if(rtPending&&rtEnabled){rtPending=false;schedRT();}
      return;
    }
    document.getElementById('story-generating').style.display='none';
    const body=document.getElementById('story-body');
    curStory={paragraphs:parsed.paragraphs,moralia:parsed.moralia||'',raw:parsed.paragraphs.map(p=>'['+p.func+']\n'+p.text).join('\n\n')};
    parsed.paragraphs.forEach(p=>{
      const div=document.createElement('div');div.className='story-para';
      if(p.func){const tag=document.createElement('div');tag.className='story-func-tag';tag.textContent=p.func.toUpperCase();div.appendChild(tag);}
      const txt=document.createElement('div');txt.className='story-para-text';txt.textContent=p.text;div.appendChild(txt);
      body.appendChild(div);
    });
    if(isF&&parsed.moralia){document.getElementById('moralia-text').textContent=parsed.moralia;document.getElementById('story-moralia').style.display='block';}
  }catch(err){
    document.getElementById('story-generating').style.display='none';document.getElementById('story-placeholder').style.display='block';
    document.getElementById('story-placeholder').innerHTML='<span style="color:#8a2020;font-family:Cinzel,serif;font-size:12px">Error: '+err.message+'</span>';
  }
  isGen=false;if(rtPending&&rtEnabled){rtPending=false;schedRT();}
}

const API_LINKS={groq:'https://console.groq.com/keys',mistral:'https://console.mistral.ai/api-keys/',gemini:'https://aistudio.google.com/app/apikey',claude:'https://console.anthropic.com/settings/keys'};
const API_PLACEHOLDERS={groq:'API key Groq‚Ä¶',mistral:'API key Mistral‚Ä¶',gemini:'API key Google‚Ä¶',claude:'API key Anthropic‚Ä¶'};

function loadSavedKey(model){
  try{const k=localStorage.getItem('ppc_key_'+model);if(k){document.getElementById('api-key').value=k;}}catch(e){}
}
function saveCurrentKey(){
  const model=document.getElementById('model-sel').value;
  const key=document.getElementById('api-key').value.trim();
  try{localStorage.setItem('ppc_key_'+model,key);
    const btn=document.getElementById('btn-save-key');btn.textContent='‚úì';setTimeout(()=>btn.textContent='üíæ',1500);
  }catch(e){}
}
document.getElementById('btn-save-key').addEventListener('click',saveCurrentKey);
document.getElementById('model-sel').addEventListener('change',function(){
  document.getElementById('api-link').href=API_LINKS[this.value]||'#';
  document.getElementById('api-key').placeholder=API_PLACEHOLDERS[this.value]||'Clave API‚Ä¶';
  loadSavedKey(this.value);
});
// Cargar key guardada del modelo inicial al arrancar
loadSavedKey('groq');

// ‚îÄ‚îÄ PHASE SELECTOR ‚îÄ‚îÄ
function savePhase(){
  if(!selectedCard)return;
  const newPhase=document.getElementById('phase-sel').value;
  const id=normId(selectedCard.id);
  // Remove from all groups
  Object.keys(NARRATIVE_GROUPS).forEach(ph=>{
    NARRATIVE_GROUPS[ph]=NARRATIVE_GROUPS[ph].filter(x=>normId(x)!==id);
    PHASE[id]=null;
  });
  // Add to new group
  NARRATIVE_GROUPS[newPhase].push(id);PHASE[id]=newPhase;
  // Persist in custom
  if(!custom[selectedCard.id])custom[selectedCard.id]={};
  custom[selectedCard.id].phase=newPhase;saveC();
  renderSpread();
  const btn=document.querySelector('#stab-config .btn-dk');btn.textContent='‚úì Guardado';
  setTimeout(()=>btn.textContent='Guardar fase',1500);
}

// patch showSidebar to populate phase selector
// ‚îÄ‚îÄ MONOMITO DATA ‚îÄ‚îÄ
const MONOMITO_STAGES=[
  {id:1,name:'Mundo Ordinario',desc:'El h√©roe se nos presenta en su entorno cotidiano, antes de que comience la aventura. Es el punto de referencia emocional al que el relato vuelve transformado.',example:'Harry vive en el armario bajo la escalera. Luke cultiva humedad en Tatooine. Frodo fuma pipa en la Comarca.',propp:['alejamiento']},
  {id:2,name:'Llamada a la Aventura',desc:'Un heraldo anuncia que el mundo ordinario ha cambiado o que existe algo m√°s all√°. La carencia o el da√±o activan el deseo de actuar.',example:'Gandalf dice a Frodo que debe destruir el Anillo. R2-D2 entrega el mensaje de Leia. La ara√±a muerde a Peter Parker.',propp:['carencia','dano','informacion']},
  {id:3,name:'Rechazo de la Llamada',desc:'El h√©roe duda, teme o rechaza la aventura. Este momento humaniza al protagonista y prepara su transformaci√≥n posterior.',example:'Frodo es reacio a abandonar la Comarca. Luke duda ante la propuesta de Obi-Wan. Neo no sabe si lo que ve es real.',propp:['desobediencia','prohibicion']},
  {id:4,name:'Encuentro con el Mentor',desc:'Una figura sabia entrega al h√©roe conocimiento, objeto m√°gico o confianza para afrontar lo desconocido.',example:'Obi-Wan entrena a Luke. Morfeo ofrece la p√≠ldora roja. El hada madrina equipa a Cenicienta.',propp:['mediacion','donacion']},
  {id:5,name:'Cruce del Umbral',desc:'El h√©roe abandona definitivamente el mundo ordinario y entra en el mundo especial. No hay vuelta atr√°s.',example:'La Comunidad inicia el viaje hacia Mordor. Neo toma la p√≠ldora roja. Harry entra por primera vez al Callej√≥n Diagon.',propp:['partida','aceptacion','complicidad']},
  {id:6,name:'Pruebas, Aliados y Enemigos',desc:'El h√©roe aprende las reglas del mundo especial a trav√©s de una serie de pruebas menores. Forma alianzas y descubre sus primeros enemigos.',example:'Harry se adapta a Hogwarts. Han Solo y Chewbacca se unen a Luke. Spider-Man comienza su vida heroica.',propp:['viaje','reaccion','interrogatorio','engano']},
  {id:7,name:'Aproximaci√≥n a la Caverna',desc:'El h√©roe se prepara para la prueba mayor. Hay un momento de calma tensa antes de la crisis central.',example:'Harry planea recuperar la Piedra Filosofal. La Estrella de la Muerte destruye Alderaan. Nala convence a Simba.',propp:['tarea','trampa']},
  {id:8,name:'Ordal√≠a',desc:'La crisis central. El h√©roe enfrenta su mayor miedo o enemigo. A menudo hay una muerte simb√≥lica o literal de la que renacer√° transformado.',example:'Obi-Wan se sacrifica ante Darth Vader. Simba enfrenta la verdad sobre Mufasa. Frodo es traicionado por Gollum.',propp:['combate','fracaso','marca']},
  {id:9,name:'Recompensa',desc:'Tras superar la ordal√≠a, el h√©roe obtiene la recompensa: objeto, conocimiento, amor o poder que buscaba.',example:'Harry llega a la Piedra Filosofal. Neo acepta su identidad como el Elegido. Simba decide reclamar su reino.',propp:['exito','solucion']},
  {id:10,name:'Camino de Regreso',desc:'El h√©roe inicia el retorno al mundo ordinario, pero el peligro a√∫n no ha terminado. La recompensa debe protegerse.',example:'Luke participa en el ataque a la Estrella de la Muerte. Spider-Man lucha contra el Duende Verde. Frodo se acerca al Monte.',propp:['regreso','persecucion','socorro']},
  {id:11,name:'Resurrecci√≥n',desc:'El cl√≠max final. El h√©roe debe aplicar todo lo aprendido en una √∫ltima prueba que transforma su ser para siempre.',example:'Neo muere y resucita como el Elegido. Simba derrota a Scar. Luke usa la Fuerza para destruir la Estrella de la Muerte.',propp:['reconocimiento','desenmascaramiento','disfraz']},
  {id:12,name:'Retorno con el Elixir',desc:'El h√©roe regresa al mundo ordinario transformado, portando el elixir: el conocimiento, el objeto o la sabidur√≠a que beneficia a su comunidad.',example:'Frodo regresa a la Comarca transformado. Neo libera la mente humana. Simba se convierte en rey.',propp:['castigo','boda']}
];

let mmData={};
let mmSelected=null;
let mmOrder=[1,2,3,4,5,6,7,8,9,10,11,12]; // current segment order
let mmRotation=0; // visual rotation of the wheel in degrees

function loadMM(){
  try{
    const d=sessionStorage.getItem('ppc_mm');
    if(d){const p=JSON.parse(d);mmData=p.data||p;mmOrder=p.order||[1,2,3,4,5,6,7,8,9,10,11,12];mmRotation=p.rotation||0;}
  }catch(e){}
}
function saveMM(){
  try{sessionStorage.setItem('ppc_mm',JSON.stringify({data:mmData,order:mmOrder,rotation:mmRotation}));}catch(e){}
  // Trigger real-time regen if active
  if(typeof rtEnabled!=='undefined' && rtEnabled && typeof storySrc!=='undefined' && storySrc==='monomito'){
    schedRT();
  }
}

function renderMMTimeline(){
  const tl=document.getElementById('tl-mm');
  tl.innerHTML='';
  let tlDragSrc=null;

  // Split into two rows of 6
  const rows=[[...mmOrder.slice(0,6)],[...mmOrder.slice(6,12)]];

  rows.forEach((row,ri)=>{
    const rowEl=document.createElement('div');
    rowEl.className='tl-mm-row';
    row.forEach((id,ii)=>{
      const globalIdx=ri*6+ii;
      if(ii>0){
        const arr=document.createElement('span');
        arr.className='tl-mm-arrow';
        arr.textContent='‚Üí';
        rowEl.appendChild(arr);
      }
      const stage=MONOMITO_STAGES.find(s=>s.id===id);
      const sp=document.createElement('span');
      const isActive=mmSelected===id;
      const isDone=!!(mmData[id]&&mmData[id].text);
      sp.className='tl-mm-item'+(isActive?' active':isDone?' done':'');
      sp.textContent=stage.id+'. '+stage.name;
      sp.draggable=true;
      sp.dataset.stageId=id;
      sp.addEventListener('click',()=>selectMMStage(id));
      sp.addEventListener('dragstart',e=>{
        tlDragSrc=globalIdx;
        e.dataTransfer.effectAllowed='move';
        setTimeout(()=>sp.style.opacity='0.4',0);
      });
      sp.addEventListener('dragend',()=>{sp.style.opacity='';});
      sp.addEventListener('dragover',e=>{e.preventDefault();sp.style.outline='2px solid var(--ink)';});
      sp.addEventListener('dragleave',()=>{sp.style.outline='';});
      sp.addEventListener('drop',e=>{
        e.preventDefault();sp.style.outline='';
        if(tlDragSrc!==null && tlDragSrc!==globalIdx){
          const newOrder=[...mmOrder];
          const [item]=newOrder.splice(tlDragSrc,1);
          newOrder.splice(globalIdx,0,item);
          mmOrder=newOrder;
          saveMM();
          buildWheel();
        }
        tlDragSrc=null;
      });
      rowEl.appendChild(sp);
    });
    tl.appendChild(rowEl);
  });
}

function buildWheel(){
  const svg=document.getElementById('monomito-svg');
  svg.innerHTML='';
  const n=12, R=210, r=94, cx=0, cy=0;
  const POP=26;

  // Outer dashed ring (fixed, doesn't rotate)
  const ring=document.createElementNS('http://www.w3.org/2000/svg','circle');
  ring.setAttribute('cx',cx);ring.setAttribute('cy',cy);ring.setAttribute('r',R+16);
  ring.setAttribute('fill','none');ring.setAttribute('stroke','var(--rule)');
  ring.setAttribute('stroke-width','0.7');ring.setAttribute('stroke-dasharray','4 6');
  svg.appendChild(ring);

  // ‚îÄ‚îÄ ROTATING GROUP ‚Äî all segments live here ‚îÄ‚îÄ
  const wheelG=document.createElementNS('http://www.w3.org/2000/svg','g');
  wheelG.id='mm-wheel-g';
  wheelG.setAttribute('transform',`rotate(${mmRotation})`);
  svg.appendChild(wheelG);

  // Inner circle ‚Äî sits ON TOP of wheelG, stays fixed, is the drag handle
  const inner=document.createElementNS('http://www.w3.org/2000/svg','circle');
  inner.setAttribute('cx',cx);inner.setAttribute('cy',cy);inner.setAttribute('r',r-5);
  inner.setAttribute('fill','var(--white)');inner.setAttribute('stroke','var(--ink)');inner.setAttribute('stroke-width','2');
  inner.style.cursor='grab';
  svg.appendChild(inner);

  // Center label (also fixed, on top)
  const ct=document.createElementNS('http://www.w3.org/2000/svg','text');
  ct.setAttribute('x',0);ct.setAttribute('y',6);ct.setAttribute('text-anchor','middle');
  ct.setAttribute('font-family','UnifrakturMaguntia,serif');ct.setAttribute('font-size','16');
  ct.setAttribute('fill','var(--ink)');ct.textContent='Monomito';
  ct.style.pointerEvents='none';
  svg.appendChild(ct);

  const slotAngle = 2*Math.PI/n;

  const getAngleDeg=e=>{
    const rect=svg.getBoundingClientRect();
    const mx=((e.clientX-rect.left)/rect.width)*500-250;
    const my=((e.clientY-rect.top)/rect.height)*500-250;
    return Math.atan2(my,mx)*180/Math.PI;
  };
  const getAngleRad=e=>{
    const rect=svg.getBoundingClientRect();
    const mx=((e.clientX-rect.left)/rect.width)*500-250;
    const my=((e.clientY-rect.top)/rect.height)*500-250;
    return Math.atan2(my,mx);
  };

  // ‚îÄ‚îÄ WHEEL ROTATION ‚Äî drag center circle only ‚îÄ‚îÄ
  let rotDragStart=null, rotBase=mmRotation;
  let segmentDragActive=false; // set true while dragging a segment
  inner.addEventListener('mousedown',ev=>{
    if(segmentDragActive)return; // don't spin while reordering
    ev.preventDefault();ev.stopPropagation();
    rotDragStart=getAngleDeg(ev);
    rotBase=mmRotation;
    inner.style.cursor='grabbing';
    const onMove=e=>{
      const a=getAngleDeg(e);
      let da=a-rotDragStart;
      while(da>180)da-=360;while(da<-180)da+=360;
      mmRotation=rotBase+da;
      wheelG.setAttribute('transform',`rotate(${mmRotation})`);
    };
    const onUp=()=>{
      inner.style.cursor='grab';
      saveMM();
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
    };
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });

  for(let i=0;i<n;i++){
    const stageId=mmOrder[i];
    const stage=MONOMITO_STAGES.find(s=>s.id===stageId);
    const angle   = slotAngle*i - Math.PI/2;
    const nextAng = angle + slotAngle;
    const midAng  = angle + slotAngle/2;
    const isActive= mmSelected===stageId;
    const isDone  = !!(mmData[stageId]&&mmData[stageId].text);

    const mkPath=(ri,ro,a0,a1)=>{
      const x1=cx+ri*Math.cos(a0),y1=cy+ri*Math.sin(a0);
      const x2=cx+ro*Math.cos(a0),y2=cy+ro*Math.sin(a0);
      const x3=cx+ro*Math.cos(a1),y3=cy+ro*Math.sin(a1);
      const x4=cx+ri*Math.cos(a1),y4=cy+ri*Math.sin(a1);
      return `M${x1} ${y1} L${x2} ${y2} A${ro} ${ro} 0 0 1 ${x3} ${y3} L${x4} ${y4} A${ri} ${ri} 0 0 0 ${x1} ${y1}Z`;
    };

    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    let cls='mm-segment';
    if(isActive) cls+=' active';
    if(isDone&&!isActive) cls+=' done';
    g.setAttribute('class',cls);

    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('class','mm-seg-path');
    path.setAttribute('d',mkPath(r,R,angle,nextAng));
    path.setAttribute('stroke','var(--ink)');path.setAttribute('stroke-width','1.3');
    g.appendChild(path);

    // Number near outer edge (fixed to stage.id ‚Äî won't change on reorder)
    const outerR = R - 14;
    const nx = cx + outerR*Math.cos(midAng), ny = cy + outerR*Math.sin(midAng);
    const nText=document.createElementNS('http://www.w3.org/2000/svg','text');
    nText.setAttribute('x',nx);nText.setAttribute('y',ny);
    nText.setAttribute('text-anchor','middle');nText.setAttribute('dominant-baseline','middle');
    nText.setAttribute('font-family','Cinzel,serif');nText.setAttribute('font-size','11');
    nText.setAttribute('font-weight','700');nText.setAttribute('class','mm-seg-num');
    nText.textContent=stage.id;
    g.appendChild(nText);

    // Name label rotated along arc
    const lr=(r+R)/2;
    const lx=cx+lr*Math.cos(midAng), ly=cy+lr*Math.sin(midAng);
    const lText=document.createElementNS('http://www.w3.org/2000/svg','text');
    lText.setAttribute('x',lx);lText.setAttribute('y',ly);
    lText.setAttribute('text-anchor','middle');lText.setAttribute('dominant-baseline','middle');
    lText.setAttribute('font-family','Cinzel,serif');lText.setAttribute('font-size','8');
    lText.setAttribute('class','mm-seg-label');
    lText.setAttribute('transform',`rotate(${(midAng*180/Math.PI)+90},${lx},${ly})`);
    const words=stage.name.split(' ');
    if(words.length>2){
      const half=Math.ceil(words.length/2);
      const t1=document.createElementNS('http://www.w3.org/2000/svg','tspan');
      t1.setAttribute('x',lx);t1.setAttribute('dy','-4.5');t1.textContent=words.slice(0,half).join(' ');
      const t2=document.createElementNS('http://www.w3.org/2000/svg','tspan');
      t2.setAttribute('x',lx);t2.setAttribute('dy','10');t2.textContent=words.slice(half).join(' ');
      lText.appendChild(t1);lText.appendChild(t2);
    }else{lText.textContent=stage.name;}
    g.appendChild(lText);

    // Done dot
    if(isDone){
      const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx',cx+(R-10)*Math.cos(midAng));
      dot.setAttribute('cy',cy+(R-10)*Math.sin(midAng));
      dot.setAttribute('r','4');
      dot.setAttribute('class','mm-done-dot');
      g.appendChild(dot);
    }

    const applyPop=(active)=>{
      if(active){
        const dx=Math.cos(midAng)*POP, dy=Math.sin(midAng)*POP;
        g.setAttribute('transform',`translate(${dx},${dy})`);
        g.classList.add('mm-dragging');
      }else{
        g.removeAttribute('transform');
        g.classList.remove('mm-dragging');
      }
    };

    g.addEventListener('mousedown',ev=>{
      ev.preventDefault();ev.stopPropagation();
      segmentDragActive=true;
      // SET ACTIVE IMMEDIATELY ‚Äî black on mousedown
      mmSelected=stageId;
      svg.querySelectorAll('.mm-segment').forEach(el=>el.classList.remove('active'));
      g.classList.add('active');
      let dragStart=getAngleRad(ev);
      let currentSlot=i, dragging=false;
      applyPop(true);

      const onMove=e=>{
        const a=getAngleRad(e);
        let da=a-dragStart;
        while(da>Math.PI)da-=2*Math.PI;
        while(da<-Math.PI)da+=2*Math.PI;
        const slots=Math.round(da/slotAngle);
        if(Math.abs(slots)>=1){
          dragging=true;
          const newSlot=(currentSlot+slots+n)%n;
          if(newSlot!==currentSlot){
            const newOrder=[...mmOrder];
            const [item]=newOrder.splice(currentSlot,1);
            newOrder.splice(newSlot,0,item);
            mmOrder=newOrder;
            currentSlot=newSlot;
            dragStart=a;
            buildWheel();
            const newG=svg.querySelectorAll('.mm-segment')[newSlot];
            if(newG){
              const newMid=slotAngle*newSlot-Math.PI/2+slotAngle/2;
              const dx=Math.cos(newMid)*POP,dy=Math.sin(newMid)*POP;
              newG.setAttribute('transform',`translate(${dx},${dy})`);
              newG.classList.add('mm-dragging');
            }
            renderMMTimeline();
          }
        }
      };
      const onUp=()=>{
        segmentDragActive=false;
        document.removeEventListener('mousemove',onMove);
        document.removeEventListener('mouseup',onUp);
        applyPop(false);
        if(!dragging) selectMMStage(stageId);
        else{saveMM();buildWheel();}
      };
      document.addEventListener('mousemove',onMove);
      document.addEventListener('mouseup',onUp);
    });

    wheelG.appendChild(g);
  }
  renderMMTimeline();
}


function selectMMStage(id){
  mmSelected=id;
  buildWheel(); // redraws with active class
  const stage=MONOMITO_STAGES.find(s=>s.id===id);
  const pos=mmOrder.indexOf(id);
  document.getElementById('mm-stage-num-label').textContent='ETAPA '+(pos+1)+' ¬∑ MONOMITO';
  document.getElementById('mm-stage-name-label').textContent=stage.name;
  document.getElementById('monomito-empty').style.display='none';
  document.getElementById('monomito-detail').style.display='block';
  document.getElementById('mm-stage-desc').textContent=stage.desc;
  document.getElementById('mm-stage-example').textContent=stage.example;
  const userText=(mmData[id]&&mmData[id].text)||'';
  const ut=document.getElementById('mm-user-text');
  ut.textContent=userText||'(sin contenido ‚Äî pulsa ‚úé para editar)';
  ut.style.fontStyle=userText?'normal':'italic';
  ut.style.color=userText?'var(--ink)':'var(--rule)';
  document.getElementById('mm-edit-area').style.display='none';
  document.getElementById('mm-save-btn').style.display='none';
  const container=document.getElementById('mm-propp-cards');container.innerHTML='';
  const allCards=[...CARDS_DATA,...(custom.__extra||[])];
  stage.propp.forEach(pid=>{
    const card=allCards.find(c=>normId(c.id)===normId(pid));
    if(!card)return;
    const div=document.createElement('div');div.className='spread-card';
    const img=document.createElement('img');img.src=getImg(card.id);img.alt=card.title;
    const lbl=document.createElement('div');lbl.className='spread-card-name';lbl.textContent=card.title;
    div.appendChild(img);div.appendChild(lbl);
    div.addEventListener('click',()=>{selectCard(card);showTab('card');});
    container.appendChild(div);
  });
}

function toggleMMEdit(){
  const ea=document.getElementById('mm-edit-area'),sv=document.getElementById('mm-save-btn');
  if(ea.style.display==='block'){ea.style.display='none';sv.style.display='none';}
  else{ea.value=(mmData[mmSelected]&&mmData[mmSelected].text)||'';ea.style.display='block';sv.style.display='inline-block';ea.focus();}
}
function saveMMText(){
  if(!mmSelected)return;
  if(!mmData[mmSelected])mmData[mmSelected]={};
  mmData[mmSelected].text=document.getElementById('mm-edit-area').value.trim();
  saveMM();selectMMStage(mmSelected);
}
let mmScale=1;
function mmZoom(delta){
  mmScale=Math.min(2.2,Math.max(0.4,mmScale+delta));
  document.getElementById('monomito-svg').style.transform=`scale(${mmScale})`;
}
function mmZoomReset(){
  mmScale=1;
  document.getElementById('monomito-svg').style.transform='scale(1)';
}

function clearMonomito(){
  mmData={};mmOrder=[1,2,3,4,5,6,7,8,9,10,11,12];mmRotation=0;saveMM();mmSelected=null;
  buildWheel();
  document.getElementById('monomito-empty').style.display='flex';
  document.getElementById('monomito-detail').style.display='none';
  document.getElementById('mm-stage-num-label').textContent='';
  document.getElementById('mm-stage-name-label').textContent='';
}

function downloadMMFragments(){
  const lines=[];
  lines.push('MONOMITO ‚Äî FRAGMENTOS NARRATIVOS');
  lines.push('='.repeat(40));
  mmOrder.forEach((id,i)=>{
    const stage=MONOMITO_STAGES.find(s=>s.id===id);
    const text=(mmData[id]&&mmData[id].text)||'';
    lines.push('');
    lines.push('ETAPA '+(i+1)+': '+stage.name.toUpperCase());
    lines.push('-'.repeat(30));
    lines.push(text||'(sin contenido)');
  });
  const content=lines.join('\n');
  // Show copy modal ‚Äî download blocked in sandboxed iframe
  let modal=document.getElementById('mm-export-modal');
  if(!modal){
    modal=document.createElement('div');
    modal.id='mm-export-modal';
    modal.style.cssText='position:fixed;inset:0;background:rgba(14,12,8,0.75);z-index:3000;display:flex;align-items:center;justify-content:center';
    modal.innerHTML=`
      <div style="background:var(--white);border:3px solid var(--black);box-shadow:10px 10px 0 var(--ink);padding:24px 28px;max-width:560px;width:90%;position:relative;max-height:80vh;display:flex;flex-direction:column">
        <div style="font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--ink-lt);margin-bottom:10px;text-transform:uppercase">Fragmentos del Monomito</div>
        <textarea id="mm-export-ta" readonly style="flex:1;min-height:300px;background:var(--paper);border:2px solid var(--ink);color:var(--black);font-family:'EB Garamond',serif;font-size:13px;padding:10px;resize:none;overflow-y:auto;white-space:pre;font-variant-ligatures:none"></textarea>
        <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end">
          <button class="btn btn-dk btn-sm" id="mm-copy-btn" onclick="
            document.getElementById('mm-export-ta').select();
            document.execCommand('copy');
            this.textContent='‚úì Copiado';
            setTimeout(()=>this.textContent='‚éò Copiar todo',1800);
          ">‚éò Copiar todo</button>
          <button class="btn btn-lt btn-sm" onclick="document.getElementById('mm-export-modal').style.display='none'">Cerrar</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
  document.getElementById('mm-export-ta').value=content;
  modal.style.display='flex';
}

// ‚îÄ‚îÄ Shared AI caller ‚îÄ‚îÄ
async function callAI(key,model,prompt,maxTokens,forceJson){
  maxTokens=maxTokens||2000;
  if(model==='claude'){
    // Claude: use system prompt to enforce JSON
    const body={model:'claude-sonnet-4-6',max_tokens:maxTokens,messages:[{role:'user',content:prompt}]};
    if(forceJson) body.system='Responde √öNICAMENTE con JSON v√°lido. Sin texto adicional. Sin bloques de c√≥digo markdown. Sin explicaciones.';
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify(body)});
    const d=await r.json();if(d.error)throw new Error(d.error.message);return d.content[0].text;
  }else if(model==='groq'){
    const body={model:'llama-3.3-70b-versatile',messages:[{role:'user',content:prompt}],max_tokens:maxTokens};
    if(forceJson) body.response_format={type:'json_object'};
    const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(body)});
    const d=await r.json();if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));return d.choices[0].message.content;
  }else if(model==='mistral'){
    const body={model:'mistral-large-latest',messages:[{role:'user',content:prompt}],max_tokens:maxTokens};
    if(forceJson) body.response_format={type:'json_object'};
    const r=await fetch('https://api.mistral.ai/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(body)});
    const d=await r.json();if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));return d.choices[0].message.content;
  }else if(model==='gemini'){
    const cfg={maxOutputTokens:maxTokens,thinkingConfig:{thinkingBudget:0}};
    if(forceJson) cfg.responseMimeType='application/json';
    const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key='+key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:cfg})});
    const d=await r.json();if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));
    return (d.candidates[0].content.parts||[]).filter(p=>p.text&&!p.thought).map(p=>p.text).join('');
  }
  throw new Error('Modelo desconocido');
}

function parseJSON(raw){
  if(!raw||typeof raw!=='string') throw new Error('empty response');

  // Strategy 1: direct parse (model returned clean JSON)
  try{ return JSON.parse(raw.trim()); }catch(e){}

  // Strategy 2: normalize quotes + strip markdown fences + extract {‚Ä¶}
  let c=raw
    .replace(/[\u201C\u201D\u201E\u201F]/g,'"')
    .replace(/[\u2018\u2019\u201A\u201B]/g,"'")
    .replace(/```[\w]*\s*/g,'')   // ```json or ``` opener
    .replace(/```\s*/g,'')         // ``` closer
    .replace(/`/g,'')              // stray backticks
    .trim();
  try{ return JSON.parse(c); }catch(e){}

  // Strategy 3: extract outermost { ‚Ä¶ }
  const s=c.indexOf('{'), e=c.lastIndexOf('}');
  if(s>=0 && e>s){
    try{ return JSON.parse(c.slice(s,e+1)); }catch(e){}
  }

  // Strategy 4: fix unescaped newlines inside string values then extract
  const fixed=c.replace(/:\s*"([\s\S]*?)(?<!\\)"/g,(_,v)=>':"'+v.replace(/\n/g,' ').replace(/\r/g,'')+'"');
  const s2=fixed.indexOf('{'), e2=fixed.lastIndexOf('}');
  if(s2>=0 && e2>s2){
    try{ return JSON.parse(fixed.slice(s2,e2+1)); }catch(e){}
  }

  throw new Error('JSON parse failed after all strategies');
}

async function genMonomito(onlyEmpty){
  const key=(document.getElementById('api-key').value||'').replace(/[^\x21-\x7E]/g,'').trim();
  const model=document.getElementById('model-sel').value;
  if(!key){alert('Introduce tu API key en el Scriptorium.');return;}
  const proppCtx=timeline.length>0?'\nCartas Propp activas: '+timeline.map(c=>c.title).join(', '):'';
  const stagesInfo=mmOrder.map(id=>{
    const s=MONOMITO_STAGES.find(x=>x.id===id);
    const ex=mmData[id]&&mmData[id].text;
    if(onlyEmpty&&ex)return null;
    return `${id}. ${s.name}${ex?' (ya escrita: '+ex+')':''}`;
  }).filter(Boolean).join('\n');
  if(!stagesInfo){alert('Todas las etapas ya tienen contenido.');return;}
  const prompt=`Genera contenido narrativo para estas etapas del Monomito de Campbell.${proppCtx}\n\nETAPAS:\n${stagesInfo}\n\nPara cada etapa: un p√°rrafo breve (40-60 palabras) que describa lo que ocurre.\n\nSOLO JSON. SIN TEXTO ADICIONAL:\n{"stages":[{"id":1,"text":"texto"},...]}`;
  const btn=document.querySelector('#monomito-actions .btn-dk');btn.textContent='‚ú¶ Generando‚Ä¶';btn.disabled=true;
  try{
    const raw=await callAI(key,model,prompt,2000,true);
    const parsed=parseJSON(raw);
    parsed.stages.forEach(s=>{if(!mmData[s.id])mmData[s.id]={};mmData[s.id].text=s.text;});
    saveMM();buildWheel();if(mmSelected)selectMMStage(mmSelected);
  }catch(e){alert('Error al generar: '+e.message);}
  btn.textContent='‚öú Generar monomito';btn.disabled=false;
}

// init monomito on tab click
document.querySelectorAll('.ttab').forEach(t=>{
  if(t.dataset.panel==='monomito')t.addEventListener('click',()=>{loadMM();buildWheel();});
});

// Mouse wheel zoom on the monomito panel
document.getElementById('monomito-wheel-wrap').addEventListener('wheel',e=>{
  e.preventDefault();
  mmZoom(e.deltaY<0?0.08:-0.08);
},{passive:false});

init();
</script>
</body>
</html>